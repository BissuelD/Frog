.. _tuto_quadrupole_long_page:

================================
Quadrupole and Long range QM/MM
================================

.. contents:: Table of Contents
    :depth: 3
    :local:
    

Goal and Perquisite: 
====================


In this advanced tutorial we will see how to:

    + Include in a more advance way the 'long-range' environement 
    + Compute the first hyperpolarizability up to the quadrupole order
    
    
You should be familiar to the standard command presented in the :ref:`get started tutorial<get_started_on_frog_tutorial_page>` and the one presented in the :ref:`optical property overview<tuto_optical_analysis_overview_page>`. 

The file needed to run this tutorial are located at: *Frog/Doc/Tutorial_files/Traj/Tutorial_files/Traj/Tuto_get_strated* for the MD trajectory and *Frog/Doc/Tutorial_files/Beta_quadrupole* for all the other documents.


Parameter file: 
================

Long range inclusion
---------------------

In the classic PE scheme, the environment is included explicitly up to a given distance defined by :ref:`qmparameter.max_pe_distance_neigh<autodoc_qmparameter_max_pe_distance_neigh>`.
However, above a given distance, for instance about 10 angstrom for water in the bulk phase, the neigborgs plays not such an important role. 
Indeed, the electrostatic field they generated decreases, and so there spatial gradient.
Hence, one may want to reduce the size of the explicite environement to speed up the calculation. 
To do so, a new attribute :ref:`qmparameter.long_range_distance_switch<autodoc_qmparameter_long_range_distance_switch>` can be used: ::
    
    qmparameter.calculation_style = 'PE' 
    qmparameter.pe_level = 0
    qmparameter.max_pe_distance_neigh = 20
    qmparameter.long_range_distance_switch = 10

In this example, the environement around a molecule until 20 angstrom is included. 
However, the neighborgs after 10 angstrom are not explicitly included. 
The *total* electrostatic field generated by all the neighborgs froim 10 to 10 angstrom is computed at the *mean position* of the target molecule. 
this total electrostatic field is included in the QM box as a spatial homogenous electric field (hence interacting at the dipolar order). 

.. warning:: Today qmparameter.long_range_distance_switch can be used **only for PE0 and point charge** electrostatic description. A few work may be needed to use this scheme for higher electrostatic description order and/or polarization. Contact us. 

This extra electric field will be included in the ground state calculation in top of the explicite environement. 
The optical property computed using this scheme include the environement up to qmparameter.max_pe_distance_neigh. 

.. note:: We recommand to test the distance to switch from explicite to implicite format. 

To keep track of the effect of the environement after qmparameter.long_range_distance_switch, one can use the electric field diagram: ::

    L_diagram_analysis_to_perform = [
    ['electric_field', 'Averaged', [1, 200], [-10, 10], 'PE'],
    ['beta', 'Averaged', [1, 200], [-35, 35]],
    ['chi', 'Averaged', [1, 200], [-35, 35]]
                              ]

In this case, the electric field generated will contains the electric field (and its spatial gradient) generated by the explicite and long-range neighborhood in the molecular and laboratory frame. 
See the notebook associated for more details.     

Quadrupolar first hyperpolarizability
--------------------------------------

As presented in REF, the quadrupolar first hyperpolarizablity can be obtained using the response scheme, and do not demande more information than the dipolar order (except a few more transtion state integral). 
To require the calculation, simply add `beta_order='quadrupole'`: :: 
    
    moleculetype.read_optic_properties_input(GP, ..., beta_order='quadrupole', ...)
    
New first hyperpolarizability diagram in the molecular (beta) or laboratory (chi) will be created. 
As for the frequency calculation, 2 new diagrams are created: with 'dq' and 'qd' label for dipole-quadrupole and quadrupole-dipole respectively. 

.. warning:: The value in these diagram are directly the one proposed by |dalton|. See the attached jupyter notebook for conventions discussion. 

Procedure: 
============

No differences from 'usual' |frog| run arrises once the parameter file defined this way. 
The environement is still writen, but with smaller number of neighborgs. 
The |dalton| input file are quite different (see the .dal one), but the calculation is very similar. 
The reading of the |dalton| output is also very different, but you should not noticed it -- or it krashes... 

.. note:: When using the diagram electric_field with the option 'PE', you **have to** skip the first part if any QM calculation is already performed. Otherwise the creation of the environement is not done (because there is already a QM results available) and this the electrostatic calculation. This will lead to krash later on. 


As for the overview tutorial, you can bypass the QM calculation by copying a |dalton| results provided in the directory (the *dalton_molecule_potential.out* file). 
This results is not linked to the |dalton| parameters you have defined in the tutorial, but this way you can try out the analysis jupyter nootebook by endding the |frog| procedure without any calculation done by yourself. 

Note that the QM calculation are most expensive if the quadrupolar first hyperpolarizability are computed.



