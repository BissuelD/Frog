<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frog.main &#8212; Frog 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/_static/css/s4defs-roles.css" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Frog.main</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    FROG: FROm molecular dynamics to second harmonic Generation             #</span>
<span class="c1">#    Copyright (C) 2024                                                      #</span>
<span class="c1">#    Author list                                                             #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    Guillaume Le Breton                                                     #</span>
<span class="c1">#    Oriane Bonhomme                                                         #</span>
<span class="c1">#    Emmanuel Benichou                                                       #</span>
<span class="c1">#    Claire Loison                                                           #</span>
<span class="c1">#                                                                            # </span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify    #</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by    #</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or       #</span>
<span class="c1">#    (at your option) any later version.                                     #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,         #</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of          #</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           #</span>
<span class="c1">#    GNU General Public License for more details.                            #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    You should have received a copy of the GNU General Public License       # </span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/    #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span> 
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">MDAnalysis</span>

<span class="kn">import</span> <span class="nn">Frog.toolbox</span> <span class="k">as</span> <span class="nn">toolbox</span>
<span class="kn">import</span> <span class="nn">Frog.messages</span> <span class="k">as</span> <span class="nn">messages</span>
<span class="kn">import</span> <span class="nn">Frog.check</span> <span class="k">as</span> <span class="nn">check</span>
<span class="kn">import</span> <span class="nn">Frog.error_messages</span> <span class="k">as</span> <span class="nn">error_messages</span>

<span class="kn">import</span> <span class="nn">Frog.first_part</span> <span class="k">as</span> <span class="nn">first_part</span>
<span class="kn">import</span> <span class="nn">Frog.second_part</span> <span class="k">as</span> <span class="nn">second_part</span>
<span class="kn">import</span> <span class="nn">Frog.third_part</span> <span class="k">as</span> <span class="nn">third_part</span>

<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="frog_run_from_shell">
<a class="viewcode-back" href="../../Frog.html#Frog.main.frog_run_from_shell">[docs]</a>
<span class="k">def</span> <span class="nf">frog_run_from_shell</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function  to run FROG from non-python environement, typically from the shell.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;FROG: FROm molecular dynamics to second harmonic Generation&#39;</span><span class="p">)</span>
    <span class="c1"># We open the file to make sure we have access and it exists.</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;input_file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">),</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The input parameter file for FROG run&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log_file&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;frog_log.txt&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The full log file. To help you understand what goes wrong or to check the parameter values. The location of the file is the same as the parameter input file.&#39;</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">input_file</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">log_file</span>

    <span class="n">input_file_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    
    <span class="c1"># Log file:</span>
    <span class="n">log_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_name_dir</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The log file is: &#39;</span><span class="p">,</span> <span class="n">log_file_full</span><span class="p">)</span> 
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file_full</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_to_write</span><span class="p">:</span> <span class="c1"># to clean the old log file</span>
        <span class="n">file_to_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;FROG log File</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_file_full</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> : </span><span class="si">%(name)s</span><span class="s1"> [</span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(funcName)s</span><span class="s1">:</span><span class="si">%(lineno)s</span><span class="s1">] </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> 
    
    <span class="c1"># input file: </span>
    <span class="c1"># We add the directory  where the input file is located to PYTHONPATH to be able to open it as module for python:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_file_name_dir</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The directory </span><span class="si">%s</span><span class="s1"> has been added to sys.path. It should contains the input parameter file.&#39;</span><span class="p">,</span> <span class="n">input_file_name_dir</span><span class="p">)</span>
    <span class="c1"># Set the name of the input file without the path. The directory where the file is located has already been added to the PYTHONPATH, and the loading of the file can have trouble otherwise. </span>
    <span class="n">name_input_file</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">name</span>
    <span class="c1"># print(name_input_file)</span>
    <span class="c1"># This loop aim to give a clean module name: instead of /location/file_name.py, gives: file_name.py</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_input_file</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">trotter</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trotter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name_input_file</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">trotter</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">trotter</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name_input_file</span> <span class="o">=</span> <span class="n">name_input_file</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>     
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The understood name of the input parameter file is: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name_input_file</span><span class="p">)</span>
    
    <span class="c1"># Run frog! </span>
    <span class="n">frog_run</span><span class="p">(</span><span class="n">name_input_file</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="frog_run">
<a class="viewcode-back" href="../../Frog.html#Frog.main.frog_run">[docs]</a>
<span class="k">def</span> <span class="nf">frog_run</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The programme to call to start anything. First, it reads the input file -- the argument of this function. Then, 3 parts can be run: </span>
<span class="sd">    </span>
<span class="sd">    - First Part:</span>
<span class="sd">        Perform trajectory analysis which does not involve QM calculations and/or prepare the scripts needed to perform QM calculations. The results are stored for every frame. </span>
<span class="sd">    </span>
<span class="sd">    - Second Part:</span>
<span class="sd">        If any QM calculations have to be performed, check how many run should be launched. Depending on the options, some runs can be skipted or redone. The output of this part will be scripts cluster-intended. The user has to launch the QM run in the cluster manually after the end of this second part. If any QM calculation has to be performed at the end of the second part, the last part is not run and the software stops.</span>
<span class="sd">    </span>
<span class="sd">    - Third Part:</span>
<span class="sd">        If QM calculation has been performed, read the results and stored them. Finally, merged the results of each frame and performed statistical analysis if asked.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">initial_msg_welcome</span><span class="p">()</span> <span class="c1"># Welcoming message.</span>
    
    <span class="n">check</span><span class="o">.</span><span class="n">is_it_python_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> <span class="c1"># Only .py file are accepted as input file. Note that the path to find this file should be defined within the name of the file. e.g. &#39;/home/user/parameter_frog.py&#39;</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_1</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> 

    <span class="c1"># Read the input file</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Reading the input file and initialized the run&#39;</span><span class="p">)</span>
    <span class="n">GP</span><span class="p">,</span> <span class="n">L_moleculetype</span> <span class="o">=</span> <span class="n">read_input</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;End initialization&#39;</span><span class="p">)</span>
    
    <span class="c1"># Cut the trajectory if needed: </span>
    <span class="n">GP</span><span class="o">.</span><span class="n">cut_trajectory</span><span class="p">()</span>
    
    <span class="c1"># First part of the run</span>
    <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">pass_first_part</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_66_a</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
        <span class="n">time_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_have_found_the_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">time_step</span> <span class="o">&lt;</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step</span> <span class="ow">and</span> <span class="n">i_have_found_the_file</span><span class="p">:</span>   <span class="c1">#check that the L_moleculetype are available are available for all the time steps:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L_moleculetype_temp</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">open_pickle</span><span class="p">(</span><span class="s1">&#39;L_moleculetype_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_mol_times</span><span class="p">)</span>
                <span class="n">time_step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_66_b</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)</span>
                <span class="n">i_have_found_the_file</span> <span class="o">=</span> <span class="kc">False</span>
                
        <span class="k">if</span> <span class="n">i_have_found_the_file</span><span class="p">:</span>
            <span class="n">skip_first_part</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip_first_part</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="n">skip_first_part</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_66_c</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">IS_run_QM</span><span class="p">:</span>
            <span class="c1"># make sure the submission script is not here. Otherwise weird behaviours can happen...</span>
            <span class="n">toolbox</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="s1">&#39;job_to_perform.p&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_submission_file</span><span class="p">)</span>
        <span class="n">skip_first_part</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_first_part</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;First part: Analysis of the MD&#39;</span><span class="p">)</span>
        <span class="n">time_i</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">launch_first_part</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">)</span>
        <span class="n">time_f</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">delta_t</span><span class="p">,</span> <span class="n">delta_t_string</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">diff_time</span><span class="p">(</span><span class="n">time_i</span><span class="p">,</span> <span class="n">time_f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The First part took: &#39;</span> <span class="o">+</span> <span class="n">delta_t_string</span> <span class="o">+</span> <span class="s1">&#39;, in sec: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta_t</span><span class="p">))</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;End First part&#39;</span><span class="p">)</span>
        
    <span class="c1"># Second part of the run</span>
    <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">IS_run_QM</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Second part: Lunch the QM run&#39;</span><span class="p">)</span>
        <span class="n">time_i</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">sould_i_continue</span> <span class="o">=</span> <span class="n">launch_second_part</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
        <span class="n">time_f</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">delta_t</span><span class="p">,</span> <span class="n">delta_t_string</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">diff_time</span><span class="p">(</span><span class="n">time_i</span><span class="p">,</span> <span class="n">time_f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Second part took: &#39;</span> <span class="o">+</span> <span class="n">delta_t_string</span> <span class="o">+</span> <span class="s1">&#39;, in sec: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta_t</span><span class="p">))</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;End Second part&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sould_i_continue</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_67_a</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_67_b</span><span class="p">()</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_67_c</span><span class="p">()</span>
    
    <span class="c1"># Third part of the run</span>
    <span class="n">time_i</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Third part: Fill the diagrams&#39;</span><span class="p">)</span>
    <span class="n">L_moleculetype</span> <span class="o">=</span> <span class="n">launch_third_part</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
    <span class="n">time_f</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">delta_t</span><span class="p">,</span> <span class="n">delta_t_string</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">diff_time</span><span class="p">(</span><span class="n">time_i</span><span class="p">,</span> <span class="n">time_f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The Third part took: &#39;</span> <span class="o">+</span> <span class="n">delta_t_string</span> <span class="o">+</span> <span class="s1">&#39;, in sec: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta_t</span><span class="p">))</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;End Third part&#39;</span><span class="p">)</span>
    
    <span class="c1">#End of FROG run</span>
    <span class="n">time_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">delta_t</span><span class="p">,</span> <span class="n">delta_t_string</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">diff_time</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The total Frog run time is: &#39;</span> <span class="o">+</span> <span class="n">delta_t_string</span> <span class="o">+</span> <span class="s1">&#39;, in sec: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta_t</span><span class="p">))</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;FROG run finished without error!&#39;</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.main.read_input">[docs]</a>
<span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read the input file and initialize the run. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Start reading the parameter script&#39;</span><span class="p">)</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">__import__</span><span class="p">(</span><span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;End reading the parameter script&#39;</span><span class="p">)</span>
    
    <span class="n">GP</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">GP</span>
    <span class="n">L_moleculetype</span> <span class="o">=</span> <span class="n">input_file</span><span class="o">.</span><span class="n">L_moleculetype</span>
    
    <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Final check before starting the run:&#39;</span><span class="p">)</span>
    <span class="n">GP</span><span class="o">.</span><span class="n">check_all_MT_initialized</span><span class="p">(</span><span class="n">L_moleculetype</span><span class="p">)</span>
    <span class="n">GP</span><span class="o">.</span><span class="n">check_GP</span><span class="p">()</span>
    <span class="n">GP</span><span class="o">.</span><span class="n">initializating_software_friendly_GP</span><span class="p">(</span><span class="n">L_moleculetype</span><span class="p">)</span> <span class="c1"># updating the options/information considering all the molecule type declared.</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">)</span>   </div>


<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="launch_first_part">
<a class="viewcode-back" href="../../Frog.html#Frog.main.launch_first_part">[docs]</a>
<span class="k">def</span> <span class="nf">launch_first_part</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Perform the MD analysis and prepare the QM run. If several core are available, run in parrallel. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">L_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GP&#39;</span> <span class="p">:</span> <span class="n">GP</span><span class="p">}</span> <span class="c1"># I have to pack this on a dictionary in order to pass only one argument later on during the parralelizaztion process. Other method may be tried  (but this one worked on the first develloper cluster). If this parralelization despleased you or if you have better suggestion please let me know. </span>
    <span class="n">toolbox</span><span class="o">.</span><span class="n">save_pickle</span><span class="p">(</span><span class="s1">&#39;L_moleculetype_empty.p&#39;</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_mol_times</span><span class="p">)</span> <span class="c1"># save empty diagram. It will be open later on. It has been done to avoid trouble if the diagrams are large.</span>
    <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">first_part</span><span class="o">.</span><span class="n">treat_block_of_frame</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step</span><span class="p">],</span> <span class="n">L_dict</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toolbox</span><span class="o">.</span><span class="n">parallelize_fct</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">first_part</span><span class="o">.</span><span class="n">treat_block_of_frame</span><span class="p">,</span> <span class="n">L_dict</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="launch_second_part">
<a class="viewcode-back" href="../../Frog.html#Frog.main.launch_second_part">[docs]</a>
<span class="k">def</span> <span class="nf">launch_second_part</span><span class="p">(</span><span class="n">GP</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Prepare the script used to run the QM calculations on a cluster. </span>
<span class="sd">    First read/check how many QM calculations have been performed / have to be performed</span>
<span class="sd">    Then, if any left to do, write scripts to launch them. </span>
<span class="sd">    </span>
<span class="sd">    If QM calculations should be performed, the FROG run ends at the end of this function. </span>
<span class="sd">    Otherwise, the FROG run continues with the third part.</span>
<span class="sd">    &#39;&#39;&#39;</span>          
    <span class="n">L_QM_todo</span><span class="p">,</span> <span class="n">L_nbr_job_todo</span> <span class="o">=</span> <span class="n">second_part</span><span class="o">.</span><span class="n">how_many_QM_jobs_are_left</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
    <span class="n">nbr_job_todo</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">L_nbr_job_todo</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nbr_job_todo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sould_i_continue</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># all the job have been done</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All the expected QM jobs have terminated sucessfully!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">sould_i_continue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">second_part</span><span class="o">.</span><span class="n">prepare_submission_scripts</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">L_QM_todo</span><span class="p">,</span> <span class="n">L_nbr_job_todo</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sould_i_continue</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="launch_third_part">
<a class="viewcode-back" href="../../Frog.html#Frog.main.launch_third_part">[docs]</a>
<span class="k">def</span> <span class="nf">launch_third_part</span><span class="p">(</span><span class="n">GP</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read the QM results and store them into the diagrams. </span>
<span class="sd">    </span>
<span class="sd">    Then, perform averaging over all the time step. </span>
<span class="sd">    </span>
<span class="sd">    This function can be run in parralelle.</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="c1"># If their are QM jobs, then the results have to be loaded in the moletype files:</span>

    <span class="n">L_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GP&#39;</span> <span class="p">:</span> <span class="n">GP</span><span class="p">}</span> 
    <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">third_part</span><span class="o">.</span><span class="n">run_third_part</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step</span><span class="p">],</span> <span class="n">L_dict</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toolbox</span><span class="o">.</span><span class="n">parallelize_fct</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">third_part</span><span class="o">.</span><span class="n">run_third_part</span><span class="p">,</span> <span class="n">L_dict</span><span class="p">)</span>

    <span class="c1"># Merge all the diagrams: run over all the group of time-step:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Merging the results: &#39;</span><span class="p">)</span>
    <span class="n">L_moleculetype_total</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">open_pickle</span><span class="p">(</span><span class="s1">&#39;L_moleculetype_merged_0.p&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_mol_times</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">L_time_step_management</span> <span class="o">=</span> <span class="p">[[</span><span class="n">K</span><span class="o">*</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">L_time_step_management</span> <span class="o">=</span> <span class="p">[[</span><span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)]</span> 
            <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">L_time_step_management</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_time_step_core</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">nbr_parr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_parra</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">time_step_management</span> <span class="o">=</span> <span class="n">L_time_step_management</span><span class="p">[</span><span class="n">nbr_parr</span><span class="p">]</span>
            <span class="n">L_moleculetype_temp</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">open_pickle</span><span class="p">(</span><span class="s1">&#39;L_moleculetype_merged_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_step_management</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_mol_times</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_type_molecule</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">moleculetype_tomerge</span> <span class="o">=</span> <span class="n">L_moleculetype_temp</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>
                <span class="n">moleculetype_total</span> <span class="o">=</span> <span class="n">L_moleculetype_total</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>
                <span class="n">moleculetype_total</span><span class="o">.</span><span class="n">merge_frame</span><span class="p">(</span><span class="n">moleculetype_tomerge</span><span class="p">)</span>
                
    <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">nbr_type_molecule</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># final step: axis bulding and mean/sd normalization</span>
        <span class="n">moleculetype_total</span> <span class="o">=</span> <span class="n">L_moleculetype_total</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>            
        <span class="n">moleculetype_total</span><span class="o">.</span><span class="n">end_diagram</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
        
    <span class="n">toolbox</span><span class="o">.</span><span class="n">save_pickle</span><span class="p">(</span><span class="s1">&#39;L_moleculetype_result.p&#39;</span><span class="p">,</span> <span class="n">L_moleculetype_total</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">general_path</span><span class="p">)</span>
    <span class="n">toolbox</span><span class="o">.</span><span class="n">save_pickle</span><span class="p">(</span><span class="s1">&#39;GP.p&#39;</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">GP</span><span class="o">.</span><span class="n">general_path</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">L_moleculetype_total</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/frog_logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/how_to_install_frog.html">1. How to Install Frog?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials/tutorial_index.html">2. Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GlobalParameter/gp_index.html">3. Global Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MoleculeType/mt_index.html">4. Molecule Type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Diagram/diagram_index.html">5. Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalAnalysis/optical_analysis_index.html">6. Optical Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Frog.html">7. Frog package</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Guillaume Le Breton.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>