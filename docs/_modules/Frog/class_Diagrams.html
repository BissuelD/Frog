<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frog.class_Diagrams &#8212; Frog 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/_static/css/s4defs-roles.css" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Frog.class_Diagrams</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    FROG: FROm molecular dynamics to second harmonic Generation             #</span>
<span class="c1">#    Copyright (C) 2024                                                      #</span>
<span class="c1">#    Author list                                                             #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    Guillaume Le Breton                                                     #</span>
<span class="c1">#    Oriane Bonhomme                                                         #</span>
<span class="c1">#    Emmanuel Benichou                                                       #</span>
<span class="c1">#    Claire Loison                                                           #</span>
<span class="c1">#                                                                            # </span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify    #</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by    #</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or       #</span>
<span class="c1">#    (at your option) any later version.                                     #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,         #</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of          #</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           #</span>
<span class="c1">#    GNU General Public License for more details.                            #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    You should have received a copy of the GNU General Public License       # </span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/    #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">Frog.toolbox</span> <span class="k">as</span> <span class="nn">toolbox</span>
<span class="kn">import</span> <span class="nn">Frog.geometry_manager</span> <span class="k">as</span> <span class="nn">geometry_manager</span>
<span class="kn">import</span> <span class="nn">Frog.universe_manager</span> <span class="k">as</span> <span class="nn">universe_manager</span>
<span class="kn">import</span> <span class="nn">Frog.class_modules</span> <span class="k">as</span> <span class="nn">class_modules</span>
<span class="kn">import</span> <span class="nn">Frog.dalton_manager_module</span> <span class="k">as</span> <span class="nn">dalton_manager_module</span>
<span class="kn">import</span> <span class="nn">Frog.messages</span> <span class="k">as</span> <span class="nn">messages</span>
<span class="kn">import</span> <span class="nn">Frog.error_messages</span> <span class="k">as</span> <span class="nn">error_messages</span>
<span class="kn">from</span> <span class="nn">Frog.error_messages</span> <span class="kn">import</span> <span class="n">NotAnOptionError</span>
<span class="kn">import</span> <span class="nn">Frog.electric_field_module</span> <span class="k">as</span> <span class="nn">electric_field_module</span>

<span class="kn">from</span> <span class="nn">Frog.class_DiagramParameter</span> <span class="kn">import</span> <span class="n">SingleDiagramParameter</span>
<span class="kn">from</span> <span class="nn">Frog.class_DiagramParameter</span> <span class="kn">import</span> <span class="n">sdparameter_create_axis</span>
<span class="kn">from</span> <span class="nn">Frog.class_DiagramParameter</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">Class_unit</span>
<span class="kn">from</span> <span class="nn">Frog.class_DiagramParameter</span> <span class="kn">import</span> <span class="n">frog_axis</span>

<span class="kn">from</span> <span class="nn">Frog.class_OpticalParameter</span> <span class="kn">import</span> <span class="n">QMDescription</span>
<span class="kn">from</span> <span class="nn">Frog.class_OpticalParameter</span> <span class="kn">import</span> <span class="n">ElectrostaticDescription</span>

<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="str_to_class">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.str_to_class">[docs]</a>
<span class="k">def</span> <span class="nf">str_to_class</span><span class="p">(</span><span class="n">classname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return a class knowing the classname.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">classname</span><span class="p">))</span></div>


<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>

<div class="viewcode-block" id="Diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram">[docs]</a>
<span class="k">class</span> <span class="nc">Diagram</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialized the diagram for any diagram type.</span>
<span class="sd">        Contains:</span>
<span class="sd">        </span>
<span class="sd">        size: [tuple] The discretization number. Exemple: (2,3,50). IT IS VERY IMPORTANT THAT THIS ATTRIBUE IS A TUPLE!</span>
<span class="sd">        population: [int] Can not be equal to sum(self.value)</span>
<span class="sd">        value: [array of int] The number of occurence for the discretization asked. </span>
<span class="sd">        valuesquare: [array of int] The square of the array value. It is computed at the end of a frame. This is used to compute the standard deviation later on.</span>
<span class="sd">        mean: [array] The mean value</span>
<span class="sd">        sd: [array] The standard deviation. It will used as the mean^2 during all the Frog procedure and at the very end used to store the real standard deviation.</span>
<span class="sd">        unit: [unit] The unit of this diagram. See the class unit for more information. This value will be initialize only for the merged diagram.</span>
<span class="sd">        axis: [axis] Several axis can be stored, it described the different &#39;&#39;real&#39;&#39; value corresponding to the discretization. See the class axis for more information. These values will be initialize only for the merged diagram. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;valuesquare&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_population&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_observable&#39;</span><span class="p">,</span> <span class="s1">&#39;axis_space&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span>
        
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">real_space_discretization_bin_number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#there is a special selection in the same space axis. The diagram size is not the same as the number of bin to discretize the space axis:</span>
            <span class="n">size_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_item</span> <span class="k">for</span> <span class="n">a_item</span> <span class="ow">in</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">]</span>
            <span class="n">size_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">real_space_discretization_bin_number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">size_item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span><span class="p">:</span>
                <span class="n">mean_size_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">a_item</span> <span class="k">for</span> <span class="n">a_item</span> <span class="ow">in</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span><span class="p">]</span>
                <span class="n">mean_size_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">real_space_discretization_bin_number</span>
                <span class="n">mean_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">mean_size_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean_size</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span> <span class="c1"># no mean_size for this diagram</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
            <span class="n">mean_size</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valuesquare</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mean_size</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mean_size</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the mean of the diagram </span><span class="si">%s</span><span class="s1">, the size is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_size</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mean_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mean_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mean_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the axis_population of the diagram </span><span class="si">%s</span><span class="s1">, the size is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mean_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span> <span class="o">=</span> <span class="kc">False</span>
       
    
        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prevent the attribution of undefine object to the class. This help avoiding bad spelling mistakes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NotAnOptionError</span><span class="p">(</span><span class="s1">&#39;The name </span><span class="si">%r</span><span class="s1"> is not a valide attribute for the Diagram.&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NotAnOptionError</span><span class="p">(</span><span class="s1">&#39;The name </span><span class="si">%r</span><span class="s1"> is not a valide attribute for the Diagram.&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
<span class="c1">#################################################################################################################################           </span>
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [string]  </span>
<span class="sd">        </span>
<span class="sd">        The diagram name. Defined by the analysis it refers to, along with the discretization parameters and sometimes some parameters of the analysis.</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        If the analysis required is the &#39;molecular orientation&#39; and the space-discreatization is made over the position of the molecule with respect to the laboratory z-axis, the name of the diagram will be *molecular_orientation_slice_z*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    
    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.name values can only be string.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting the Diagram name to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [tuple]  </span>
<span class="sd">        </span>
<span class="sd">        The size of the distribution. The first element is the space discretization, the other refers to the observable discretization -- and depends on the analysis performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_size</span><span class="p">)</span>
    
    <span class="nd">@size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.size values can only be tuple.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting Diagram </span><span class="si">%s</span><span class="s1"> size to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [integer]  </span>
<span class="sd">        </span>
<span class="sd">        The total number of molecule that participate to this diagram. For the case where no geometrical discretization is performed, it is just (Number of molecule) X (Number of time). For the other geormetrical selection it can become more structure-dependent and time-dependent. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_population</span><span class="p">)</span>
    
    <span class="nd">@population</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.population values can only be integer.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_population</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [numpy array]  </span>
<span class="sd">        </span>
<span class="sd">        The distribution of the observable across the geometrical selection. The size of the array is given by the size attribute. It is an non-normalized distribution: it contains only the number of molecule found to have the observable value in a given range. The normalization is up to the user. If you want to perform the normalization with respect to the total number of molecule which participated to this distribution, use the attribute population. If some geometrical selection is used (for instance along a laboratory axis), one can use the  axis_population attribute to normalized the space-discretize distribution with respect to the number of molecule which participated to the distribution for every space-bin. See axis_population attribute for more details.</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        For a density analysis along the z laboratory axis with a number of bin 100 ( input parameter: [&#39;density&#39;, &#39;Plane_xy&#39;, [100]). The my_diagram.value attribute is a list of size 100 – given also by my_diagram.size. The mean position of the water molecule are computed for every frame, and the position along the z laboratory axis is discretize into 100 bin with respect to the box size in the z direction. Let&#39;s say, the box size along the z direction is 150 A. Therefore, a molecule with mean position along the z axis 74 A corresponds to the 50th bin. Thus, for every molecule with a z mean position of 74 A, |frog| adds 1 in the 50th bin of my_diagram.value – i.e. my_diagram.value[49] since python list index starts from 0.</span>

<span class="sd">        Another example more complex using the molecular orientation. In this case, the input used to generate the diagram is [&#39;molecular_orientation&#39;, &#39;Plane_xy&#39;, [100, 100], &#39;independent&#39;] in the input file. For a given molecule, Frog will perform two discretization: one regarding the mean position (like the previous case) and one regarding the molecular orientation. Let’s say the mean position of the molecule in the z laboratory axis is 89 A and the molecular orientation is [-0.89, 0.1, 0.42]. As for the above example, the space discretization uses 100 bin. The mean position 89 A correspond to the 60th bin. In order to discretize the molecular orientation (the observable), 100 bin is also used. The molecular orientation range from -1 to 1 (projections). Therefore, a molecular orientation of [-0.89, 0.1, 0.42] correspond to the bin 6, 56 and 72. Since the independent distribution is required here, the my_diagram.value will be a 100X3X100 array – given also by my_diagram.size. If Frog found a molecule with a z laboratory axis mean position of 89 A and a molecular orientation of [-0.89, 0.1, 0.42], it will add 1 to the elements:my_diagram.value[59][0][5], my_diagram.value[59][1][55] and my_diagram.value[59][2][71].</span>

<span class="sd">        Note: If the join distribution was asked, the my_diagram.value will be a 100X100X100X100 array – given also by my_diagram.size. In this case, the molecule would lead to only one element update: my_diagram.value[59][5][55][71].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
    
    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.value values can only be numpy array.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valuesquare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [numpy array]  </span>
<span class="sd">        </span>
<span class="sd">        At the end of a frame analysis, the attribute &#39;value&#39; at the power 2 is stored in the attribute &#39;valuesquare&#39;. When merging the results of all the time step treated, the &#39;value&#39; and &#39;valuesquare&#39; of every diagram are summed respectively. This attribute can be used to compute the standard deviation later on for the distribution. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        It is assumed that the observable are correlated for a given frame. See HERE for more details. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_valuesquare</span><span class="p">)</span>
    
    <span class="nd">@valuesquare</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">valuesquare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.value values can only be numpy array.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_valuesquare</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [float or list of float]  </span>
<span class="sd">        </span>
<span class="sd">        For all the analysis type except the ‘density’ and the ‘rdf’ (for Radial Distribution Function), mean value and standard deviation are already available in the diagram object using the attribute mean and sd. </span>
<span class="sd">        </span>
<span class="sd">        The size of the mean and sd depend on the analysis performed. If space discretization is required, the mean and sd are computed with respect to the same geometrical selection.  </span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        The input used to generate the diagram is [&#39;molecular_orientation&#39;, &#39;Plane_xy&#39;, [100, 100], &#39;independent&#39;]. The size of the value distribution is 100 X 3 X 100. The first 100 bin refers to the geometrical selection (along the z-axis of the laboratory frame), while the other 100 bin refers to the discretization of the molecular orientation of the molecule. In this case, the mean attribute size will be 100 x 3. For every z-slice, the mean value for the 3 independent orientation are computed for every molecule found within these slices. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If no space discretisation is required, the number of </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mean</span><span class="p">)</span>
    
    <span class="nd">@mean</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c1">#very specific case. mean=False is used to tell the rest of the code to not compute the mean value. </span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.mean values can only be float or numpy array (of float).&#39;</span><span class="p">)</span>
        <span class="c1"># logging.info(&#39;Setting Diagram %s size to %s&#39;, self.name, value) too much print </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mean</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################  </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [float or list of float]  </span>
<span class="sd">        </span>
<span class="sd">       The standard deviation relative to the mean value of the &#39;mean&#39; attribute. The size of the sd is the same as the mean.  </span>
<span class="sd">       </span>
<span class="sd">       sd = sqrt[mean(value**2) - mean**2]</span>
<span class="sd">       </span>
<span class="sd">       If you are using time-uncorrelated frame, you may decrease this standard deviation: </span>
<span class="sd">       </span>
<span class="sd">       sd = sd/sqrt(Number time step)</span>
<span class="sd">       </span>
<span class="sd">       Or even more if you can define space-uncorrelation. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sd</span><span class="p">)</span>
    
    <span class="nd">@sd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">sd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.sd values can only be float or numpy array (of float).&#39;</span><span class="p">)</span>
        <span class="c1"># logging.info(&#39;Setting Diagram %s size to %s&#39;, self.name, value) too much print </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sd</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axis_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [list of int]  </span>
<span class="sd">        </span>
<span class="sd">        If space discretization is required and the mean value is computed, the number of molecule involve in each geometrical bin is tracked here. </span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        If the slice_ij argument is used to discretize the result along a given laboratory axis, the axis_population will be an array of the size of the number of bin used to discretize this axis. It will contains the number of molecule that participated to the diagram for every slice. If you plot the axis_population you have something proportional to the density along the discretized axis. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis_population</span><span class="p">)</span>
    
    <span class="nd">@axis_population</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">axis_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c1"># The False value is used to say to the rest of the code to not update this attribute. </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.axis_population values can only be numpy array (of int).&#39;</span><span class="p">)</span>
        <span class="c1"># logging.info(&#39;Setting the axis_population of the diagram %s&#39;, self.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_population</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [unit]  </span>
<span class="sd">        </span>
<span class="sd">        The unit of the observable, depends on the analysis performed. See the class unit for more information. ADD REF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit</span><span class="p">)</span>
    
    <span class="nd">@unit</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Class_unit</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.unit values can only be of type unit (Frog custom class).&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting Diagram </span><span class="si">%s</span><span class="s1"> unit to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">print_unit</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axis_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [frog_axis]  </span>
<span class="sd">        </span>
<span class="sd">        The x-axis of the discretize observable. You can use this axis to plot the distrubiton &#39;value&#39; along the observable direction. See the class frog_axis for more information. ADD REF.</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        To plot the (normalized) distribution of an observable for a given geometrical selection bin (here the 0th): ::</span>
<span class="sd">        </span>
<span class="sd">            plt.plot(my_diagram.axis_observable.value, my_diagram.value[0]/my_diagram.population)</span>
<span class="sd">            </span>
<span class="sd">        More examples can be found HERE.     </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis_observable</span><span class="p">)</span>
    
    <span class="nd">@axis_observable</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">axis_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">frog_axis</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.axis_observable values can only beof type frog_axis (Frog curstom class).&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting the axis_observable of the diagram </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_observable</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axis_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [frog_axis]  </span>
<span class="sd">        </span>
<span class="sd">        The x-axis of the space selection. If no space selection is performed, this axis is useless. If you performed axis discretization, it will contains the position of the slices along the chosen axis. You can use this axis to plot the distrubiton &#39;value&#39; along the geometrical discretization, or perform 2D plot along with the axis_observable axis. See the class frog_axis for more information. ADD REF.</span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        To plot the mean value along the spacial discretization: ::</span>
<span class="sd">        </span>
<span class="sd">            plt.errorbar(my_diagram.axis_space.value, my_diagram.mean, yerr=my_diagram.sd)</span>
<span class="sd">            </span>
<span class="sd">        More examples can be found HERE.   </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis_space</span><span class="p">)</span>
    
    <span class="nd">@axis_space</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">axis_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">frog_axis</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.axis_space values can only beof type frog_axis (Frog curstom class).&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting the axis_space of the diagram </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_space</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">#################################################################################################################################   </span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Diagram.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add an occurence to the diagram. The position argument MUST BE a tuple.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">position</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> </div>

        
<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="Diagram.add_population">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.add_population">[docs]</a>
    <span class="k">def</span> <span class="nf">add_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add a population to the diagram.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">+=</span> <span class="mi">1</span></div>


<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="Diagram.add_value_to_mean">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.add_value_to_mean">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_space</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add a population to the diagram.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#print(self.mean, value)</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">+=</span> <span class="n">value</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span> <span class="c1">#Same routine here fore Plane and Layer discretization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">bin_space</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">bin_space</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">bin_space</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">bin_space</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="o">**</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">[</span><span class="n">bin_space</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: code probleme!!!&#39;</span><span class="p">)</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Diagram.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the valuesquare. Should be called at the end of a frame. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valuesquare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Diagram.merge_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.merge_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherself</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Merge the result of different frame -- or more generally different diagram object. No normalization should be perfromed at this point. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">otherself</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_99</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherself</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">population</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">value</span>       
        <span class="bp">self</span><span class="o">.</span><span class="n">valuesquare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valuesquare</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">valuesquare</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">mean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">sd</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span> <span class="o">+</span> <span class="n">otherself</span><span class="o">.</span><span class="n">axis_population</span></div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Diagram.end_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.end_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Normalize the average and the standard deviation according to the total population number. </span>
<span class="sd">        Creates the axis for the diagram. This is done here so that the other temporary diagram are lighter. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The population for the diagram </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># for space-averaged value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># here depend on the space axis</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span> <span class="c1"># no sd here</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_population</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># for no space-discretization</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="o">*</span><span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_observable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_space</span> <span class="o">=</span> <span class="n">sdparameter_create_axis</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">GP</span><span class="p">)</span></div>

             
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Diagram.switch_unit_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.switch_unit_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">switch_unit_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what_to_change</span><span class="p">,</span> <span class="n">unit_to_change</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">,</span> <span class="n">custom_change</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">molar_mass</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Switch the unit of the diagram axis, not diagram.value, diagram.valuesquare or the mean and sd!!!</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">what_to_change</span> <span class="o">==</span> <span class="s1">&#39;distribution&#39;</span><span class="p">:</span>
            <span class="n">coeff_to_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">switch_unit</span><span class="p">(</span><span class="n">unit_to_change</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">,</span> <span class="n">custom_change</span><span class="o">=</span><span class="n">custom_change</span><span class="p">,</span> <span class="n">molar_mass</span><span class="o">=</span><span class="n">molar_mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">coeff_to_switch</span>
        
        <span class="k">elif</span> <span class="n">what_to_change</span> <span class="o">==</span> <span class="s1">&#39;axis_observable&#39;</span><span class="p">:</span>
            <span class="n">coeff_to_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_observable</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">switch_unit</span><span class="p">(</span><span class="n">unit_to_change</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">,</span> <span class="n">custom_change</span><span class="o">=</span><span class="n">custom_change</span><span class="p">,</span> <span class="n">molar_mass</span><span class="o">=</span><span class="n">molar_mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axis_observable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_observable</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">coeff_to_switch</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">*</span><span class="n">coeff_to_switch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="o">*</span><span class="n">coeff_to_switch</span>
                
        <span class="k">elif</span> <span class="n">what_to_change</span> <span class="o">==</span> <span class="s1">&#39;axis_space&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_space</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There is no space axis for this diagram!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coeff_to_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_space</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">switch_unit</span><span class="p">(</span><span class="n">unit_to_change</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">,</span> <span class="n">custom_change</span><span class="o">=</span><span class="n">custom_change</span><span class="p">,</span> <span class="n">molar_mass</span><span class="o">=</span><span class="n">molar_mass</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_space</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_space</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">coeff_to_switch</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: please use either &quot;distribution&quot;, &quot;axis_observable&quot; or &quot;axis_space&quot; for the first argument to chose what you want to change the unit.&#39;</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="Diagram.add_empty_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Diagram.add_empty_diagram">[docs]</a>
    <span class="nd">@staticmethod</span>    
    <span class="k">def</span> <span class="nf">add_empty_diagram</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creat a diagram of the specified type. Every diagram are the same (with respect to their attribues, e.g. value or population) but have different method associated. That is why the type of the diagram matters. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">class_temp_diagram</span> <span class="o">=</span> <span class="n">class_modules</span><span class="o">.</span><span class="n">give_class_diagram_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span><span class="p">)</span> <span class="c1"># name of the class relative to the diagram requiered</span>
        <span class="k">return</span><span class="p">(</span><span class="n">str_to_class</span><span class="p">(</span><span class="n">class_temp_diagram</span><span class="p">)(</span><span class="n">sdparameter</span><span class="p">))</span> <span class="c1"># return a diagram with the given size. The diagram will be an object of the Diagram class relative to its physical meaning (e.g. from the Dia_density class if it is a &#39;density&#39; type diagram).</span></div>
</div>


<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_density">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_density</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [Molecule \/ Angstrom\^3]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">    </span>
<span class="sd">        [&#39;density&#39;, geometrical_discretization, [N]]</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Compute the density of the system for a given molecule type. Please note that the position of a molecule is defined in its molecular module using the function: compute_mean_position. In case the position of a molecule is ouside the box, it is reput inside for the diagram calculation. Very few extra calculation is required to perform the density analysis since the mean position of every molecule is computed anyway. </span>
<span class="sd">    </span>
<span class="sd">    For the density, no extra parameters are needed, i.e., only the three basic arguments are needed to define the density analysis. </span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: N</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: No mean available</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: mean_position </span>

<span class="sd">    **Extra parameter for the SingleDiagramParameter**: Nothing</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">    </span>
<span class="sd">        [[&#39;density&#39;, &#39;Averaged&#39;, [1]], </span>
<span class="sd">        [&#39;density&#39;, &#39;Plane_xy&#39;, [100]]]</span>
<span class="sd">    </span>
<span class="sd">    Creates 2 diagrams: </span>
<span class="sd">    </span>
<span class="sd">        + One with name &#39;density&#39;, not space-discretized. Contains the number of molecule divided by the volume of the box. </span>
<span class="sd">        </span>
<span class="sd">        + One with the name &#39;density_slice_z&#39;, duscretized along the z-axis with 100 bins. The diagram.value contains the list of the number of molecule found per slices divided by the slice volume. Please note that the slice volume may depend on the MD box size. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_density.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Nothing to do, already initialized. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span> <span class="o">=</span> <span class="kc">False</span></div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_density.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis. Here the mean position of the molecule.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;mean_position&#39;</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
<div class="viewcode-block" id="Dia_density.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Already defined for every molecule: &#39;mean_position&#39; which is a 1x3 array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>


<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_density.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Should compute the mean position of the molecule according to the function &#39;&#39;mean_position&#39;&#39; defined in the molecule type library file. However, this should have been done before. If this function is called, an error is raised.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_98</span><span class="p">())</span></div>


<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_density.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">(</span><span class="n">bin_z</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span> </div>

        <span class="c1"># no super().add_to_mean() here, special case! </span>
        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_density.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_density.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#Mean value</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">L_box_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">L_box_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">L_box_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#all the box</span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span> <span class="c1">#slices</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">L_box_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">L_box_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">L_box_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># the slice </span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">discretization_type</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span> <span class="c1">#layer</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># The volume is not well defined here... </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;code problem: this should not happens! The discretization type has not been properly defined!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">volume</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span></div>
</div>

    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_molecular_orientation">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_molecular_orientation</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [Projection]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;molecular_orientation&#39;, geometrical_discretization, [N, M], Proba_style]</span>
<span class="sd">    </span>
<span class="sd">    Compute the molecular orientation of a molecule type. This &#39;&#39;molecular orientation&#39;&#39; is defined in its molecular module using the function named: compute_molecular_orientation. </span>
<span class="sd">    The molecular orientation can have an arbitrary number of values. </span>
<span class="sd">    For instance, it can be defined by 3 number (for instance 3 cosinus value). </span>
<span class="sd">    The expected value of a molecule orientation is between -1 and 1. </span>
<span class="sd">    </span>
<span class="sd">    Depending on the Proba_style used, the size of the diagram is different. </span>
<span class="sd">    If Proba_style = &#39;join&#39;, the diagram compute the joint occurence for every dimension used to describe the molecular orientation. If L number of dimensions is needed, the diagram size is: NxMxMxM...xM with L times M.</span>
<span class="sd">    If Proba_style = &#39;independent&#39;, the diagram compute the independence for every dimension used to describe the molecular orientation. If L number of dimensions is needed, the diagram size is: NxLXM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: NxLxM or NxMxM...xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: NxL any case</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: molecular_orientation </span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**: </span>
<span class="sd">        + proba_style</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [[&#39;molecular_orientation&#39;, &#39;Plane_xy&#39;, [60, 45], &#39;join&#39;], </span>
<span class="sd">        [&#39;molecular_orientation&#39;, &#39;Plane_xz&#39;, [70, 10], &#39;independent&#39;]]</span>
<span class="sd">    </span>
<span class="sd">    Let&#39;s assume there is 3 number are needed to defined the molecular angle.</span>
<span class="sd">    Creats 2 diagrams: </span>
<span class="sd">        </span>
<span class="sd">        + One with name &#39;molecular_orientation_slice_z&#39;. Contains the join probability of finding the molecular orientation. Its size is 60x45x45x45. It mean size is 60x3.</span>
<span class="sd">        </span>
<span class="sd">        + One with name &#39;molecular_orientation_slice_y&#39;. Contains the independent probability of finding the molecular orientation. Its size is 70x3x10. It mean size is 70x3.</span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_molecular_orientation.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Redefine the bin_size according to the number of value needed to describe the molecular orientation of this molecular type. </span>
<span class="sd">        Please, note that if a Plane discretization have been required, the bin number related has been already removed in sdparameter.__init__ .</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">proba_style</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">proba_style</span> <span class="o">==</span> <span class="s1">&#39;independent&#39;</span><span class="p">:</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">smparameter</span><span class="o">.</span><span class="n">d_molecular_orientation</span><span class="p">)</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_14_b</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">proba_style</span> <span class="o">==</span> <span class="s1">&#39;join&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">smparameter</span><span class="o">.</span><span class="n">d_molecular_orientation</span><span class="p">):</span>
                <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_14_b</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: distribution style not understood! Please use either &quot;independent&quot; or &quot;join&quot; as the 4th argument. See the documentation for more details.&#39;</span><span class="p">)</span>
            
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="n">smparameter</span><span class="o">.</span><span class="n">d_molecular_orientation</span><span class="p">)</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_molecular_orientation.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis. Here the molecular orientation of the molecule.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;molecular_orientation&#39;</span><span class="p">)</span>    </div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_molecular_orientation.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
        <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="s1">&#39;dummy arg&#39;</span><span class="p">)</span> <span class="c1">#no need for argument here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
            <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_molecular_orientation.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the molecular orientation of the molecule according to the function &#39;&#39;compute_molecular_orientation&#39;&#39; defined in the molecule type library file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resid &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">pos_mol_kkk</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">compute_molecular_orientation</span><span class="p">(</span><span class="n">pos_mol_kkk</span><span class="p">))</span>  </div>

        
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_molecular_orientation.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">discretization_angle</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">),</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">proba_style</span> <span class="o">==</span> <span class="s1">&#39;independent&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="o">.</span><span class="n">d_molecular_orientation</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">angle_axis</span><span class="p">,</span> <span class="n">discretization_angle</span><span class="p">[</span><span class="n">angle_axis</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">proba_style</span> <span class="o">==</span> <span class="s1">&#39;join&#39;</span><span class="p">:</span>
            <span class="n">bin_to_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_z</span><span class="p">,)</span>
            <span class="k">for</span> <span class="n">angle_axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="o">.</span><span class="n">d_molecular_orientation</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_to_add</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">concatenate_bin</span><span class="p">(</span><span class="n">bin_to_add</span><span class="p">,</span> <span class="n">discretization_angle</span><span class="p">[</span><span class="n">angle_axis</span><span class="p">])</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">(</span><span class="n">bin_to_add</span><span class="p">)</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

        
<span class="c1">#################################################################################################################################False</span>

<div class="viewcode-block" id="Dia_molecular_orientation.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_molecular_orientation.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span>   </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_hbond">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_hbond</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [H-bond]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;hbond&#39;, geometrical_discretization, [N, I, J], partner, fct_parameters]</span>
<span class="sd">        </span>
<span class="sd">    Compute the &#39;&#39;hydrogen bonds&#39;&#39; of a molecule type with another molecule type -- the &#39;&#39;partner&#39;&#39; molecule type. </span>
<span class="sd">    This &#39;&#39;hbond&#39;&#39; is defined in its molecular module or in the partner molecular module using the function named: compute_hbonds. </span>
<span class="sd">    This function should return whether one molecule or the other &#39;&#39;own&#39;&#39; or &#39;&#39;give&#39;&#39; something -- for instance an hydrogen bond. </span>
<span class="sd">    This function can be of course used to defined other things then hydrogen bounds. </span>
<span class="sd">    </span>
<span class="sd">    The important point is that this function should return only +1 for one of the molecule or 0 for both molecule. </span>
<span class="sd">    The diagram tracks the occurence of this molecule to &#39;&#39;own&#39;&#39; or &#39;&#39;give&#39;&#39; somthing with the other molecule type (joint occurence).</span>
<span class="sd">    Therefore, in the input the partner molecule type have to be defined. </span>
<span class="sd">    </span>
<span class="sd">    I and J are the maximal number of &#39;own&#39; and &#39;given&#39; hbond respectively by this MoleculeType. </span>
<span class="sd">    The &#39;mean&#39; is the independent average of the &#39;own&#39; and &#39;given&#39; hbond.</span>
<span class="sd">    </span>
<span class="sd">    The last parameter, fct_parameters, depends on the function defined on the molecular module compute_hbonds. </span>
<span class="sd">    Please, keep in mind that the function compute_hbonds can be either defined in this molecular module or in the partner molecular module for the specific couple of molecule type.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: NxIxJ</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx2 </span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: hbond\_ +  partner</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + partner = [string] The moleculartype name of the partner molecule.</span>
<span class="sd">        + which_function_to_call = [string] Either &#39;Target&#39; or &#39;Partner&#39; if the compute_hbonds should be used in this molecular module or the partner one.</span>
<span class="sd">        + fct_parameters = [list] An array of all the parameter to pass to the function which compute the hbounds. See the molecular module function compute_hbonds to now what is expected. </span>
<span class="sd">        + max_distance = [float] Define the radius to defined the neighbourood. </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;hbond&#39;, &#39;Averaged&#39;, [4, 5],  &#39;WaterTIP4P2005&#39;, [2.7, 37]]</span>
<span class="sd">    </span>
<span class="sd">    The diagram size will be 4X5.</span>
<span class="sd">    The &#39;partner&#39; MoleculeType name is WaterTIP4P2005. If there is no WaterTIP4P2005 declared, there will be zero hbond. </span>
<span class="sd">    If no ways of computing hbond between this MT and WaterTIP4P2005 are found in the compute_hbonds function of this molecular file module or the one of WaterTIP4P2005, Frog will krash. </span>
<span class="sd">    [2.7, 37] are the parameters passed to the molecular module function compute_hbonds. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Dia_hbond.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the SingleDiagramParameter with the informations given by the user. Also check if the compute_hbonds function is defined in this molecular module or in the partner molecular one. </span>
<span class="sd">        &#39;&#39;&#39;</span>  
        <span class="nb">print</span><span class="p">(</span><span class="n">smparameter</span><span class="o">.</span><span class="n">name_mt</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span> <span class="c1"># update name of the diagram        </span>

        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">fct_parameters</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        
        <span class="n">module_MT_name</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">smparameter</span><span class="o">.</span><span class="n">name_mt</span><span class="p">)</span>
        <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_MT_name</span><span class="p">)</span>
        
        <span class="n">module_MT_partner_name</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">)</span>
        <span class="n">partner_molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_MT_partner_name</span><span class="p">)</span>
        
        <span class="n">info_mol</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">compute_hbonds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">fct_parameters</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_mol</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_15</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">)</span>              
            <span class="n">info_mol</span> <span class="o">=</span> <span class="n">partner_molecule_type_module</span><span class="o">.</span><span class="n">compute_hbonds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">smparameter</span><span class="o">.</span><span class="n">name_mt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">fct_parameters</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info_mol</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_106</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sdparameter</span><span class="o">.</span><span class="n">which_function_to_call</span> <span class="o">=</span> <span class="s1">&#39;Partner&#39;</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_16</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">info_mol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">which_function_to_call</span> <span class="o">=</span> <span class="s1">&#39;Target&#39;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_17</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">info_mol</span><span class="p">)</span>                                                                
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">info_mol</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: The maximal distance authorized to find neigbors is negative: sdparameter.max_distance=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">))</span>
        
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_18</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_hbond.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule whicth hold the value relative to this analysis. Here the molecular orientation of the molecule.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;hbond_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">)</span>  </div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_hbond.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Seek in the list of asked diagram the &#39;hbond&#39; and add the attribute &#39;hbond&#39; + &#39;_&#39; + &#39; name of the molecule with which the hbond are considerated &#39;. For instance, if the hbond between this molecule type and Water or Methanol is asked, the molecule of this molecule type will have the attribute hbond_Water or hbond_Methanol.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;hbond&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_hbond.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the hbonds between a target molecule and some partner molecules  according to the function &#39;&#39;compute_hbonds&#39;&#39; defined in the target or partner molecule type library file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="c1"># First compute the neighbourghood:</span>
        <span class="n">L_target_mean_pos</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
        <span class="n">L_list_name_MT</span><span class="p">,</span> <span class="n">L_neighbourhood_names_number</span><span class="p">,</span> <span class="n">L_environment</span> <span class="o">=</span> <span class="n">universe_manager</span><span class="o">.</span><span class="n">environement_builder_return_position</span><span class="p">(</span><span class="n">kkk</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">L_name_partner</span><span class="o">=</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">)</span>
        
        <span class="n">to_add_mol_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L_environment</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> 
            <span class="n">pos_mol_target</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s2">&quot;resid &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
            <span class="n">pos_mol_target</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
            <span class="n">pos_mol_target</span> <span class="o">=</span> <span class="n">pos_mol_target</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
            <span class="k">for</span> <span class="n">molecule_partner_pos</span> <span class="ow">in</span> <span class="n">L_environment</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">which_function_to_call</span> <span class="o">==</span> <span class="s1">&#39;Target&#39;</span><span class="p">:</span>
                    <span class="n">add_target</span><span class="p">,</span> <span class="n">add_partner</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">compute_hbonds</span><span class="p">(</span><span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">,</span> <span class="n">molecule_partner_pos</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">fct_parameters</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">which_function_to_call</span> <span class="o">==</span> <span class="s1">&#39;Partner&#39;</span><span class="p">:</span>
                    <span class="n">partner_molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">))</span>
                    <span class="n">add_partner</span><span class="p">,</span> <span class="n">add_target</span><span class="o">=</span> <span class="n">partner_molecule_type_module</span><span class="o">.</span><span class="n">compute_hbonds</span><span class="p">(</span><span class="n">molecule_partner_pos</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">fct_parameters</span><span class="p">)</span>
                <span class="n">to_add_mol_target</span> <span class="o">=</span> <span class="n">to_add_mol_target</span> <span class="o">+</span> <span class="n">add_target</span>  
        <span class="k">for</span> <span class="n">KKK</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">to_add_mol_target</span><span class="p">[</span><span class="n">KKK</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="n">KKK</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span> <span class="c1">#if their is more &#39;own&#39; or &#39;given&#39; hbond than the one authorized, the value is set to the maximum. </span>
                <span class="n">to_add_mol_target</span><span class="p">[</span><span class="n">KKK</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="n">KKK</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span> 
        <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">to_add_mol_target</span><span class="p">)</span> </div>

    
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_hbond.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">nbr_hbonds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span> <span class="c1">#The hbonds numberis a 2 dimensions int array. It can goes from 0 to whatever int. The maximal number authorized is defined for the &#39;own&#39; and &#39;given&#39; hbond by the user (stored in L_diagram_temp[3]) </span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbr_hbonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbr_hbonds</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_hbond.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_hbond.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span>   </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_rdf">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_rdf</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [Molecule]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;rdf&#39;, geometrical_discretization, [N, M], partner, max_distance]</span>
<span class="sd">        </span>
<span class="sd">    Compute the radial distribution function (rdf) of a target molecule type -- the &#39;&#39;partner&#39;&#39; molecule type -- with respect to this molecule type. </span>
<span class="sd">    The distance between each molecule is defined between their &#39;mean position&#39; -- defined in their respective compute_mean_position function of their molecular module.</span>
<span class="sd">    The maximal distance to compute this rdf is set by max_distance, in Angstrom.</span>
<span class="sd">    </span>
<span class="sd">    Note that the rdf obtained is not normalized. </span>
<span class="sd">    See the get started tutorial for more information. </span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: NxM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Not defined </span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: rdf\_ +  partner</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + partner = [string] The moleculartype name of the partner molecule.</span>
<span class="sd">        + max_distance = [float] Define the maximal radius for the rdf.</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">         [&#39;rdf&#39;, &#39;Averaged&#39;, [25],  &#39;WaterTIP4P2005&#39;, 10.2] </span>
<span class="sd">    </span>
<span class="sd">    The diagram size will be 25.</span>
<span class="sd">    The &#39;partner&#39; MoleculeType name is WaterTIP4P2005. </span>
<span class="sd">    The maximal distance to find this partner is 10.2 Angstrom.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
<div class="viewcode-block" id="Dia_rdf.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and save the input. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span> <span class="c1"># update name of the diagram        </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">mean_size</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># no &#39;mean value&#39; here, hard to define?!</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: The maximal distance authorized to find neigbors is negative: sdparameter.max_distance=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">))</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_19</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_rdf.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;rdf_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">)</span>  </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_rdf.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Seek in the list of asked diagram the &#39;rdf&#39; and add the attribute &#39;hbond&#39; + &#39;_&#39; + &lt; name of the molecule with which the rdf are considerated &gt;. For instance, if the rdf between this molecule type and Water, and Methanol is asked, the molecule of this molecule type will have the attribute rdf_Water and rdf_Methanol.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;rdf&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span> <span class="c1"># = &#39;rdf_&#39; + diagram_para[4]</span>
                <span class="c1"># setattr(singlemolecule, name_attr, []) # fill with the distance between this molecule and the partner molecule (&lt;diagram_para[4]&gt;) in the neighbourhood up to a distance &lt;diagram_para[5]&gt;.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_rdf.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the distance between the target molecule and the partner molecules in the target molecule neighbourhood.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="c1"># Run over the molecule types present in the simulation (GP.L_mt_key_mt) to have the number (L_key_mol_partner) of the partner ones (if ttt[0] == L_diagram_temp[4]:).</span>
        <span class="c1"># First compute the neighbourghood:</span>
        <span class="n">L_target_mean_pos</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
        <span class="c1"># L_environment, L_neighbourhood_cleaned = universe_manager.environement_manager(kkk, L_target_mean_pos, molecule_type_module, sdparameter.max_distance, GP, u, ts, L_box_size, L_name_partner=sdparameter.partner)</span>
        <span class="n">L_list_name_MT</span><span class="p">,</span> <span class="n">L_neighbourhood_names_number</span><span class="p">,</span> <span class="n">L_environment</span> <span class="o">=</span> <span class="n">universe_manager</span><span class="o">.</span><span class="n">environement_builder_return_position</span><span class="p">(</span><span class="n">kkk</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">L_name_partner</span><span class="o">=</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L_environment</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">L_environment</span><span class="p">:</span> <span class="c1">#case where no neighbourgs have been found:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="p">[])</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">partner_molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">partner</span><span class="p">))</span>
            <span class="n">L_distance_toput</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pos_neigh_ref_target</span> <span class="ow">in</span> <span class="n">L_environment</span><span class="p">:</span>
                <span class="n">d_neigh_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">partner_molecule_type_module</span><span class="o">.</span><span class="n">compute_mean_position</span><span class="p">(</span><span class="n">pos_neigh_ref_target</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># mean position of the neigh molecule in the target molecule frame.</span>
                <span class="k">if</span> <span class="n">d_neigh_target</span> <span class="o">&lt;</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span> <span class="c1"># When the neighbourhood is built, the molecule are considerated if only one of their atoms are within the range. Thereofre, we can have the case where a molecule in the computed neighbourhood have its &#39;&#39;mean position&#39;&#39; at a larger distance than the one authorised. In this case, it is decided to not compte the molecule. </span>
                    <span class="n">L_distance_toput</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_neigh_target</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_distance_toput</span><span class="p">)</span> </div>

                    
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_rdf.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">L_d_neigh_target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">L_d_neigh_target</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># there are neighbors</span>
            <span class="n">discretization_d_neigh</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_d_neigh_target</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discretization_d_neigh</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># several neighbors</span>
                <span class="k">for</span> <span class="n">single_discretization</span> <span class="ow">in</span> <span class="n">discretization_d_neigh</span><span class="p">:</span>
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">single_discretization</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#only one neighbors</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">discretization_d_neigh</span><span class="p">))</span></div>

                
            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_rdf.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_rdf.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span>  </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_electric_field">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_electric_field</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [V/A]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;electric_field&#39;, geometrical_discretization, [N, M], [e_min, e_max] calculation_type, max_distance]</span>
<span class="sd">    </span>
<span class="sd">    Compute the electrostatic field created by the environment around each molecule of this MT. </span>
<span class="sd">    This electrostatic environment takes into account every molecules (include this MT and others). </span>
<span class="sd">    Each neighborgs are described using their electrostatic description provided by their MT module. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    The electrostatic field they produce are computed *only* at the &#39;mean position&#39; of the molecule from this MT. </span>
<span class="sd">    The return electrostatic field is the one produce by all the environment (direct sum).</span>
<span class="sd">    The spatial derivative is also computed from the individua neighborgs contribution.</span>
<span class="sd">    </span>
<span class="sd">    The results is written in Volt per Angstrom for the electrostatic field, and Volt per Angstrom square for the electrostatic field space derivative. </span>
<span class="sd">    </span>
<span class="sd">    Depending on the calculation_type used, the size of the diagram may be different. </span>
<span class="sd">    </span>
<span class="sd">    If calculation_type = &#39;on_fly&#39;, the diagram compute by itself the electrostatic field. </span>
<span class="sd">    It builts the neighborghood up to the max_distance parameter, convert it into electrostatic environment, and compute the net electrostatic field. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    If calculation_type = &#39;PE&#39;, the diagram do not compute the electrostatic field by itself. </span>
<span class="sd">    In this case, an optical property analysis which require an PE environement should be ongoing. </span>
<span class="sd">    During the preparation of the QM run (in the &#39;first part&#39; of |frog| procedure), the total electrostatic field is also stored in this diagram. </span>
<span class="sd">    Hence, the parameters used to built the environment DO NOT DEPEND ON THIS DIAGRAM but on the optical parameters.</span>
<span class="sd">    More precisely, it depends on the qmparameters used. </span>
<span class="sd">    </span>
<span class="sd">    Especially, if the division between explicite (or &#39;short&#39;) and implicite (or &#39;long-range&#39;) is required, the dimensions of the electric_field diagram is increased to store the short and long part. </span>
<span class="sd">    See :ref:`this tutorial&lt;tuto_quadrupole_long_page&gt;` for more informations. </span>
<span class="sd">    </span>
<span class="sd">    The minimal size of the diagram is: 2x?x12. </span>
<span class="sd">    The first 2 are for the laboratory or molecular frame.</span>
<span class="sd">    The ? is for the direct and long part if needed. </span>
<span class="sd">    The last 12 are for the electrostatic field and its spatial derivative. </span>
<span class="sd">    </span>
<span class="sd">    The parameters [e_min, e_max] is used to fix the minimal and maximal value to compute the distribution. </span>
<span class="sd">    Along with the number of M, it creats bins of length: (e_max-e_min)/M.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: Nx2x12xM or Nx2x2x12xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx2x12 or Nx2x2x12</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: electric_field\_ + calculation_type</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**: </span>
<span class="sd">        + min_max = [list of two float] The maximal and minimal value to discretize each component of the vector.</span>
<span class="sd">        + calculation_type = [string] Can be &#39;PE&#39; or &#39;on_fly&#39;. If PE is asked, it will be calculated using the PE environment. If &#39;on_fly&#39; it will be computed independently according to the parameter given</span>
<span class="sd">        + max_distance = [float] Define the radius to built the neighbourood used to compute the electric field. This argument should not be defined if calculation_type = &#39;PE&#39; and should be defined if calculation_type = &#39;on_fly&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [[&#39;electric_field&#39;, &#39;Averaged&#39;, [1, 14], [-10, 10], &#39;on_fly&#39;, 10.5], </span>
<span class="sd">        [&#39;electric_field&#39;, &#39;Averaged&#39;, [1, 17]], [-10, 10], &#39;PE&#39;]]</span>
<span class="sd">    </span>
<span class="sd">    It creats 2 diagrams. </span>
<span class="sd">        </span>
<span class="sd">        + electric_field_on_fly: size of 2x12x14. The electrostatic environment around each molecule of this MT is built up to 10.5 Angstrom. </span>
<span class="sd">        + electric_field_PE: size 2x12x17 is the electrostatic environment used for this MT is classic, 2x2x12x17 if there is a short-long separation. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_electric_field.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. </span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># calculation_type, can be &#39;PE&#39; or &#39;on_fly&#39;.</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;PE&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;electric field for this molecule type will be computed using the same environment as the one from the QM calculation. &#39;</span>
            <span class="c1"># size of the list: Nx2x9xM. The 2 is for laboratory or molecular frame. The 9 is for the 3 electric field value, and 9 for the derivative of the electric field. </span>
            <span class="c1"># for the &#39;Pe long&#39; case, 2 more dimension are used, for the direct and long contribution. The size is: Nx2x2x9xM</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;on_fly&#39;</span><span class="p">:</span>
            <span class="c1"># size of the list: Nx2x9xM. The 2 is for laboratory or molecular frame. The 9 is for the 3 electric field value, and 9 for the derivative of the electric field. </span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: The maximal distance authorized to find neigbors is negative: sdparameter.max_distance=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">))</span>
                        
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;electric field for this molecule type will be computed using an environment up to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">max_distance</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: the electric field calculation type can only be &quot;PE&quot; or &quot;on_fly&quot;. The given argument was: &#39;</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span>
        
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;The minimal and maximal value are: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, the number of bin used to discretized the electric field is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;. Note that the electric field and its derivative in the molecular and in the laboratory frame will be computed: the 0-2 components are the electric field in the molecular frame, from 3-5 its derivative in the molecular frame, from 6-8 the electric field in the laboratory frame and from 9-11 itd derivative in the laboratory frame.&#39;</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_electric_field.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;electric_field_&#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span><span class="p">)</span>  </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_electric_field.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add to the single_molecule object an attribute for the electric field depending on the type of electric field calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;electric_field&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_electric_field.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the electric field felt by a molecule if required (on_fly). </span>
<span class="sd">        Otherwise, the electric field calculation will be performed when the QM/MM is create, see Prepare_run_QM diagram below. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;on_fly&#39;</span><span class="p">:</span> <span class="c1"># the electric field have to be computed here</span>
            <span class="n">L_target_mean_pos</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
            <span class="n">electric_field_lab</span><span class="p">,</span> <span class="n">d_electric_field_lab</span> <span class="o">=</span> <span class="n">electric_field_module</span><span class="o">.</span><span class="n">compute_electric_field_on_fly</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">)</span>
            <span class="n">L_value_electric_field</span> <span class="o">=</span> <span class="n">electric_field_module</span><span class="o">.</span><span class="n">to_store_electric_field</span><span class="p">(</span><span class="n">electric_field_lab</span><span class="p">,</span> <span class="n">d_electric_field_lab</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_value_electric_field</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># the electric field for every molecule will be computed during the &#39;Prepare_run_QM&#39; diagram class.</span>
            <span class="k">pass</span> </div>


<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_electric_field.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span> 
        <span class="n">IS_electric_field</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;PE&#39;</span><span class="p">:</span> <span class="c1"># the electric field have to be computed here</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">),</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1">#meaning that no QM calculation for this molecule should be performed, thus no electric field have been computed. </span>
                <span class="n">IS_electric_field</span> <span class="o">=</span> <span class="kc">False</span>
                                      
        <span class="k">if</span> <span class="n">IS_electric_field</span><span class="p">:</span>
            <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
            <span class="n">L_value_electric_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L_value_electric_field</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: the electric field of the molecule &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; from the MT &#39;</span> <span class="o">+</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; has not been computed during the first part of the run. 1) If you are using the &quot;on_fly&quot; option this should not happen and this is a FROG problem. 2) If you are using the &quot;PE&quot; option you can try: a) save your QM results in another directory. b) delete all the FROG directory to have a fresh start. c) start again the calculation: the environment around each of the target QM molecule is built and the electric field calculated. d) copy back the QM results e) start again Frog with the option GP.pass_first_part = True. This should fix this issue.&#39;</span><span class="p">)</span>
            <span class="n">L_value_bin_electric_field</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_electric_field</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span> <span class="c1"># style: Nx2x12xM</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># for lab and mol</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span> <span class="c1"># for E and dE</span>
                         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">L_value_bin_electric_field</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="c1"># style: Nx2x2x12xM. The x2 added is for the direct and long assignation.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># for lab and mol</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># for direct and long contribution</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span> <span class="c1"># for E and dE</span>
                            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">L_value_bin_electric_field</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: code probleme: this case should not happen!!!&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

                                      
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_electric_field.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_electric_field.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span>    </div>
</div>

    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################   </span>

<div class="viewcode-block" id="Prepare_run_QM">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Prepare_run_QM">[docs]</a>
<span class="k">class</span> <span class="nc">Prepare_run_QM</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>   
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This Diagram class is not doing any analysis but preparing the scripts for a Dalton run. It is called whenever any &#39;&#39;optical&#39;&#39; analysis requiering an QM calculation is needed. This class will prepare the electrostatic environment if required. </span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Prepare_run_QM.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Prepare_run_QM.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;IS_QM_run&#39;</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Prepare_run_QM.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Prepare_run_QM.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize boolean to follow if the QM run of this molecule should be done (IS_QM_run). Set to &#39;TODO&#39; if the QM calculation should be done. Set to &#39;DONE&#39; if the QM calculation have been done.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="s1">&#39;dummy_arg&#39;</span><span class="p">)</span>
        <span class="c1"># setattr(singlemolecule, name_attr, False)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
            <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">singlemolecule</span><span class="p">)</span>  </div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Prepare_run_QM.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Prepare_run_QM.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if a QM run should be perform for this molecule. If so, write the .dal, .mol and .pot file. Save also the rotational matrix (to go from the molecular to the laboratory frame). </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>
        
        <span class="c1"># Check if the QM run should be perform: </span>
        <span class="c1"># Does it match special requirement?</span>
        <span class="n">should_this_calculation_be_done</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">optparameter_selection_tool_molecule</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span> <span class="c1"># if the molecule does not respect the moleculetype.mtparameter.optparameter.selection_tool option, should_i_continue_t=False. Otherwise it is True. </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_this_calculation_be_done</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">should_this_calculation_be_done</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">optparameter_where_to_run_QM_molecule</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span> <span class="c1"># if the molecule does not respect the moleculetype.mtparameter.optparameter.where_to_run_QM option, should_i_continue_t=False. Otherwise it is &#39;TODO&#39;. </span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">should_this_calculation_be_done</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">should_this_calculation_be_done</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># at this point, a QM calculation should be performed for this molecule. Hence,should_this_calculation_be_done == &#39;TODO&#39;</span>
        
        <span class="c1"># Check if an old calculation should be read instead of performing it (again).</span>
        <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">redo_QM</span> <span class="o">==</span> <span class="s1">&#39;redo&#39;</span><span class="p">:</span> <span class="c1"># always re-run the calculation.</span>
            <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">move_previous_results</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span> <span class="c1"># move the previous results if any to make sure the QM calculation are done with the actual QM parameters. </span>
        <span class="k">elif</span> <span class="n">GP</span><span class="o">.</span><span class="n">redo_QM</span> <span class="o">==</span> <span class="s1">&#39;do_not_redo&#39;</span><span class="p">:</span> <span class="c1"># We have to check if a QM calculation for this molecule is already available. </span>
            <span class="n">is_the_calculation_done</span><span class="p">,</span> <span class="n">QM_file_localization_name</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">check_if_run_already_performed</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_the_calculation_done</span><span class="p">:</span> <span class="c1">#meaning the calculation has been done</span>
                <span class="n">should_this_calculation_be_done</span> <span class="o">=</span> <span class="s1">&#39;DONE&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#meaning the calculation has not been done</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: code error, this case should not happen!!!&#39;</span><span class="p">)</span>
        
        
        <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">,</span> <span class="n">should_this_calculation_be_done</span><span class="p">)</span> <span class="c1">#either &#39;TODO&#39; or &#39;DONE&#39;</span>
        
        <span class="k">if</span> <span class="n">should_this_calculation_be_done</span> <span class="o">==</span> <span class="s1">&#39;TODO&#39;</span><span class="p">:</span> <span class="c1"># the dalton input file has to be written:</span>
            <span class="n">QM_file_localization_name</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">build_QM_file_localization</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">creat_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">L_target_mean_pos</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
            <span class="n">pos_mol_target</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s2">&quot;resid &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
            <span class="n">pos_mol_target</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">calculation_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PE + QM box&#39;</span><span class="p">]:</span>
                <span class="n">universe_manager</span><span class="o">.</span><span class="n">QM_preparation_PE_and_PE_plus_QMBox</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">,</span> <span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">QM_file_localization_name</span><span class="p">)</span>
        
            <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">calculation_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PE long&#39;</span><span class="p">]:</span>
                <span class="n">universe_manager</span><span class="o">.</span><span class="n">QM_preparation_PE_long</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">,</span> <span class="n">pos_mol_target</span><span class="p">,</span> <span class="n">QM_file_localization_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: this case should not happen!!!&#39;</span><span class="p">)</span></div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1"># There is no other function for this class as the reading and diagram filling is performed in the optical analysis below: </span>
    
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_alpha">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_alpha</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [atomic unit]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;alpha&#39;, geometrical_discretization, [N, M], [min, max]]</span>
<span class="sd">    </span>
<span class="sd">    Compute the polarizability of the molecule type in the **molecular frame**. The argument to define how the value are optained are defined in the optical parameters, :ref:`see this page&lt;overview_opt_analysis_page&gt;` or :ref:`this tutorial&lt;tuto_optical_analysis_overview_page&gt;`. </span>
<span class="sd">    </span>
<span class="sd">    Note that if no QM calculation are performed, *i.e.* fixed alpha for all the molecule, this diagram has no sens and is ignored: every molecule share the exact same value! </span>
<span class="sd">    </span>
<span class="sd">    All the optical properties are in atomic unit and also the alpha components.</span>
<span class="sd">    The min/max value given are used to performed distribution and are applied for every tensor components.  </span>
<span class="sd">    Note that these extrema value do not impact the mean and standard deviation calculation.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: Nx9xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx9</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: alpha\_ +  frequency</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + min_max = [list of two float] The maximal and minimal value to discretize each component of the tensors.</span>
<span class="sd">        + frequency = [float or string] The frequency at which the tensor is computed. If no frequency is set (or a reference value), the frequency value is replace by &#39;REF&#39;. The frequency is fixed by the optical parameters definition. </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;alpha&#39;, &#39;Averaged&#39;, [1, 30], [-15, 15]] </span>
<span class="sd">    </span>
<span class="sd">    will return an 9 X 30 diagrams. The &#39;9&#39; is because their are 9 components for this tensor.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span> 
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_alpha.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. The frequency is initialized to the default value. </span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="c1"># remark: the name of the diagram is update later on if needed. </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span> <span class="c1"># default value</span>
        
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_20</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_alpha.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">SingleDiagramParameter</span><span class="p">):</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="o">.</span><span class="n">frequency</span>
            
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;alpha_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>  </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_alpha.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add to the single_molecule object an attribute for the molecular polarizability depending on the type of calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># if a reference polarizability is set, we can already set the value for all molecules. </span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">alpha_ref</span> <span class="o">=</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_ref</span> <span class="o">=</span> <span class="kc">False</span>
       
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">singlemolecule</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">alpha_ref</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_alpha.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the polarizability from the QM calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span> 
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span> <span class="c1"># Should be called after the QM run</span>
            <span class="n">should_this_molecule_be_treated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">should_this_molecule_be_treated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># The QM run should be done for this molecule </span>
                <span class="n">QM_dir_mol</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">build_QM_file_localization</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">L_iota</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">load_iota</span><span class="p">(</span><span class="n">QM_dir_mol</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>        
                <span class="n">L_alpha</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_2nd_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">),</span> <span class="n">L_iota</span><span class="p">)</span>  
                <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_alpha</span><span class="p">)</span> </div>

                
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_alpha.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span> 
            <span class="k">pass</span>
        
        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
            <span class="n">L_value_2d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
            <span class="n">L_value_bin_2d</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_2d</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">L_value_bin_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>       
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_alpha.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_alpha.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span> </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_iota">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_iota</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [atomic unit]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;iota&#39;, geometrical_discretization, [N, M]article, [min, max]]</span>
<span class="sd">    </span>
<span class="sd">    Compute the polarizability of the molecule type in the **laboratory frame**. The argument to define how the value are optained are defined in the optical parameters, :ref:`see this page&lt;overview_opt_analysis_page&gt;` or :ref:`this tutorial&lt;tuto_optical_analysis_overview_page&gt;`. </span>
<span class="sd">    </span>
<span class="sd">    All the optical properties are in atomic unit and also the iota components.</span>
<span class="sd">    The min/max value given are used to performed distribution and are applied for every tensor components.  </span>
<span class="sd">    Note that these extrema value do not impact the mean and standard deviation calculation.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: Nx9xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx9</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: iota\_ +  frequency</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + min_max = [list of two float] The maximal and minimal value to discretize each component of the tensors.</span>
<span class="sd">        + frequency = [float or string] The frequency at which the tensor is computed. If no frequency is set (or a reference value), the frequency value is replace by &#39;REF&#39;. The frequency is fixed by the optical parameters definition. </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;iota&#39;, &#39;Averaged&#39;, [1, 30], [-15, 15]] </span>
<span class="sd">    </span>
<span class="sd">    will return an 9 X 30 diagrams. The &#39;9&#39; is because their are 9 components for this tensor.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_iota.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">SingleDiagramParameter</span><span class="p">):</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;iota_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>          </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_iota.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. The frequency is initialized to the default value. </span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="c1"># remark: the name of the diagram is update later on if needed. </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span> <span class="c1"># default value</span>
        
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_20</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>  </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_iota.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add to the single_molecule object an attribute for the laboratory polarizability depending on the type of calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;iota&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_iota.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the polarizability from the QM calculation or rotate the reference polarizability toward the laboratory frame.</span>
<span class="sd">        &#39;&#39;&#39;</span> 
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span>
            <span class="c1"># the laboratory polarizability is obtained by projecting the reference molecular polarizability to the laboratory frame. </span>
            <span class="n">L_iota</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_2nd_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span><span class="p">)</span>      
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_iota</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">should_this_molecule_be_treated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">should_this_molecule_be_treated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># The QM run should be done for this molecule </span>
                <span class="n">QM_dir_mol</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">build_QM_file_localization</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">L_iota</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">load_iota</span><span class="p">(</span><span class="n">QM_dir_mol</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>        
                <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_iota</span><span class="p">)</span> </div>

                
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_iota.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">L_value_2d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
        <span class="n">L_value_bin_2d</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_2d</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">L_value_bin_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>


<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_iota.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_iota.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span></div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_beta">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_beta</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [atomic unit]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;beta&#39;, geometrical_discretization, [N, M], [min, max]]</span>
<span class="sd">    </span>
<span class="sd">    Compute the first hyperpolarizability of the molecule type in the **molecular frame**. The argument to define how the value are optained are defined in the optical parameters, :ref:`see this page&lt;overview_opt_analysis_page&gt;` or :ref:`this tutorial&lt;tuto_optical_analysis_overview_page&gt;`. </span>
<span class="sd">    </span>
<span class="sd">    Note that if no QM calculation are performed, *i.e.* fixed beta for all the molecule, this diagram has no sens and is ignored: every molecule share the exact same value! </span>
<span class="sd">    </span>
<span class="sd">    All the optical properties are in atomic unit and also the alpha components.</span>
<span class="sd">    The min/max value given are used to performed distribution and are applied for every tensor components.  </span>
<span class="sd">    Note that these extrema value do not impact the mean and standard deviation calculation.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: Nx27xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx27</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: beta\_ +  frequency</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + min_max = [list of two float] The maximal and minimal value to discretize each component of the tensors.</span>
<span class="sd">        + frequency = [float or string] The frequency at which the tensor is computed. If no frequency is set (or a reference value), the frequency value is replace by &#39;REF&#39;. The frequency is fixed by the optical parameters definition. </span>
<span class="sd">        + beta_type = [str] The type of first hyperpolarizability. Either &#39;dipole-dipole&#39;, &#39;dipole-quadrupole&#39; or &#39;quadrupole-dipole&#39;. It affects the size of the diagram (and the attached SingleMolecule property) and how is read the tensor from the DALTON output file. See :ref:`this tutorial&lt;tuto_quadrupole_long_page&gt;` for more informations.  </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;beta&#39;, &#39;Averaged&#39;, [1, 30], [-15, 15]] </span>
<span class="sd">    </span>
<span class="sd">    will return an 27 X 30 diagrams, in the usual dipolar approximation. The &#39;27&#39; is because their are 27 components for this tensor.</span>
<span class="sd">    At the quadrupole level, some diagram (dipole-quadrupole and quadrupole-dipole) will have 3x3x3x3=81 components instead of 27. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_beta.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">SingleDiagramParameter</span><span class="p">):</span>
            <span class="n">sdparameter</span> <span class="o">=</span> <span class="n">frequency</span> <span class="c1"># renaming it otherwise it gives me headaches</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-dipole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;beta_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-quadrupole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;beta_dq_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;beta_qd_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR CODE: this case should be impossible!&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;beta_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span></div>

    
<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="Dia_beta.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. The frequency is initialized to the default value. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># remark: the name of the diagram is update later on if needed. </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span> <span class="c1"># default value</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">=</span> <span class="s1">&#39;dipole-dipole&#39;</span> <span class="c1">#default value</span>
        
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_20</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_beta.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span>  
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add to the single_molecule object an attribute for the molecular hyperpolarizability depending on the type of calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_beta_ref</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">beta_ref</span> <span class="o">=</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_beta_ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_ref</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;beta&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">singlemolecule</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">beta_ref</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_beta.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the hyperpolarizability from the QM calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span> 
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span> <span class="c1"># Should be called after the QM run</span>
            <span class="n">should_this_molecule_be_treated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">should_this_molecule_be_treated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># The QM run should be done for this molecule </span>
                <span class="n">QM_dir_mol</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">build_QM_file_localization</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">L_chi</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">load_chi</span><span class="p">(</span><span class="n">QM_dir_mol</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-dipole&#39;</span><span class="p">:</span>
                    <span class="n">L_beta</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_3rd_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">),</span> <span class="n">L_chi</span><span class="p">)</span>  
                <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-quadrupole&#39;</span> <span class="ow">or</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span><span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">:</span>
                    <span class="n">L_beta</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_4th_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">),</span> <span class="n">L_chi</span><span class="p">)</span>  
                <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_beta</span><span class="p">)</span> </div>

                
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_beta.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span> 
            <span class="k">pass</span>
        
        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
            <span class="n">L_value_3d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
            <span class="n">L_value_bin_3d</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_3d</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#L_value_3d-L_diagram_temp[4][0]-0.00001)/(np.abs(L_diagram_temp[4][1]-L_diagram_temp[4][0]))*L_diagram_temp[3][-1]).astype(int)</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-dipole&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">L_value_bin_3d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-quadrupole&#39;</span> <span class="ow">or</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span><span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">27</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="n">L_value_bin_3d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]))</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_beta.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_beta.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span> </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################        </span>
            
<div class="viewcode-block" id="Dia_chi">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_chi</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **Unit** [atomic unit]</span>
<span class="sd">    </span>
<span class="sd">    **Input format**: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;chi&#39;, geometrical_discretization, [N, M], [min, max]]</span>
<span class="sd">    </span>
<span class="sd">    Compute the first hyperpolarizability of the molecule type in the **laboratory frame**. The argument to define how the value are optained are defined in the optical parameters, :ref:`see this page&lt;overview_opt_analysis_page&gt;` or :ref:`this tutorial&lt;tuto_optical_analysis_overview_page&gt;`. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    All the optical properties are in atomic unit and also the alpha components.</span>
<span class="sd">    The min/max value given are used to performed distribution and are applied for every tensor components.  </span>
<span class="sd">    Note that these extrema value do not impact the mean and standard deviation calculation.</span>
<span class="sd">    </span>
<span class="sd">    **Diagram size**: Nx27xM</span>
<span class="sd">    </span>
<span class="sd">    **Diagram mean**: Nx27</span>
<span class="sd">    </span>
<span class="sd">    **SingleMolecule attribute**: chi\_ +  frequency</span>
<span class="sd">    </span>
<span class="sd">    **Extra parameter for the SingleDiagramParameter**:</span>
<span class="sd">        + min_max = [list of two float] The maximal and minimal value to discretize each component of the tensors.</span>
<span class="sd">        + frequency = [float or string] The frequency at which the tensor is computed. If no frequency is set (or a reference value), the frequency value is replace by &#39;REF&#39;. The frequency is fixed by the optical parameters definition. </span>
<span class="sd">        + beta_type = [str] The type of first hyperpolarizability. Either &#39;dipole-dipole&#39;, &#39;dipole-quadrupole&#39; or &#39;quadrupole-dipole&#39;. It affects the size of the diagram (and the attached SingleMolecule property) and how is read the tensor from the DALTON output file. See :ref:`this tutorial&lt;tuto_quadrupole_long_page&gt;` for more informations.  </span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    User input: ::</span>
<span class="sd">        </span>
<span class="sd">        [&#39;chi&#39;, &#39;Averaged&#39;, [1, 30], [-15, 15]] </span>
<span class="sd">    </span>
<span class="sd">    will return an 27 X 30 diagrams, in the usual dipolar approximation. The &#39;27&#39; is because their are 27 components for this tensor.</span>
<span class="sd">    At the quadrupole level, some diagram (dipole-quadrupole and quadrupole-dipole) will have 3x3x3x3=81 components instead of 27. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dia_chi.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">SingleDiagramParameter</span><span class="p">):</span>
            <span class="n">sdparameter</span> <span class="o">=</span> <span class="n">frequency</span> <span class="c1"># renaming it otherwise it gives me headaches</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-dipole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;chi_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-quadrupole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;chi_dq_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;chi_qd_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR CODE: this case should be impossible!&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="s1">&#39;chi_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span></div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_chi.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. The frequency is initialized to the default value. </span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="c1"># remark: the name of the diagram is update later on if needed. </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span> <span class="c1"># default value</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">=</span> <span class="s1">&#39;dipole-dipole&#39;</span> <span class="c1">#default value</span>
        
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_20</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span></div>

    
<span class="c1">#################################################################################################################################</span>
 
<div class="viewcode-block" id="Dia_chi.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add to the single_molecule object an attribute for the laboratory hyperpolarizability depending on the type of calculation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_chi.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the hyperpolarizability from the QM calculation or rotate the reference one toward the laboratory frame.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="k">if</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span>
            <span class="n">L_chi</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_3rd_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_beta_ref</span><span class="p">)</span>      
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_chi</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">should_this_molecule_be_treated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;IS_QM_run&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">should_this_molecule_be_treated</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># The QM run should be done for this molecule </span>
                <span class="n">QM_dir_mol</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">build_QM_file_localization</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">kkk</span><span class="p">)</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">L_chi</span> <span class="o">=</span> <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">load_chi</span><span class="p">(</span><span class="n">QM_dir_mol</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span><span class="p">)</span>        
                <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_chi</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: Dev probleme, this case should not happen...&#39;</span><span class="p">)</span></div>

            
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_chi.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>     
        <span class="n">bin_z</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">L_value_3d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
        <span class="n">L_value_bin_3d</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_3d</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-dipole&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">L_value_bin_3d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span> <span class="s1">&#39;dipole-quadrupole&#39;</span> <span class="ow">or</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">==</span><span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_z</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">27</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="n">L_value_bin_3d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_mean</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">bin_z</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_chi.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_chi.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span> </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################     </span>

<span class="c1"># END OF WORKING DIAGRAMS</span>

<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################     </span>
            
<div class="viewcode-block" id="Dia_effective_field">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field">[docs]</a>
<span class="k">class</span> <span class="nc">Dia_effective_field</span><span class="p">(</span><span class="n">Diagram</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    IMPORTANT NOTE:</span>
<span class="sd">    this part of the code is not working. It is the remaining of previous attends which may or may not be continued later on. This part of the code is not deleted so that future develpment could benefite from the already built structure. </span>
<span class="sd">    </span>
<span class="sd">    However, if you are the developer which actually work in this area, do not hesitate to start from scratch if you fell that it would be easier. </span>
<span class="sd">    </span>
<span class="sd">    Compute the effective field coefficient of the molecule type in the molecular frame. </span>
<span class="sd">    &#39;&#39;&#39;</span> 
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_effective_field.read_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.read_input">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the bin_size and the min, max value for every component. The frequency is initialized to the default value. </span>
<span class="sd">        &#39;&#39;&#39;</span>    
        <span class="c1"># remark: the name of the diagram is update later on if needed. </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># update the bin_size</span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># update the bin_size</span>
        
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span> <span class="o">=</span> <span class="n">L_input_diagram</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [min, max] value for every components </span>
        <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span> <span class="c1"># default value</span>
        <span class="c1"># sdparameter.max_norm = L_input_diagram[4] </span>
        <span class="c1"># sdparameter.max_iter = L_input_diagram[5]</span>
        <span class="c1">#print(&#39;In order to discretized the tensor, the same number of bin will be used: &#39; + str(sdparameter.bin_size[-1]) + &#39; for every tensor components. The minimal component value accepted is &#39; + str(sdparameter.min_max[0]) + &#39; [atomic unit] and the maximal is &#39; + str(sdparameter.min_max[1]) + &#39; [atomic unit]. The criteria to stop the self-consistant procedure are: maximal authorized difference in the local fiel coefficiants: &#39; + str(sdparameter.max_norm) + &#39; or maximal number of iteration: &#39; + str(sdparameter.max_iter) + &#39;.&#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In order to discretized the tensor, the same number of bin will be used: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; for every tensor components. The minimal component value accepted is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; [atomic unit].&#39;</span><span class="p">)</span></div>

        <span class="c1">#messages.user_frendly_20(sdparameter)</span>
    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_effective_field.SM_attribute_name">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.SM_attribute_name">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define the name of the attribute for a molecule with hold the value relative to this analysis.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">SingleDiagramParameter</span><span class="p">):</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="o">.</span><span class="n">frequency</span>
            
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;effective_field_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>  </div>

    
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_effective_field.initialize_single_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.initialize_single_molecule">[docs]</a>
    <span class="nd">@classmethod</span> 
    <span class="k">def</span> <span class="nf">initialize_single_molecule</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">singlemolecule</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        TODO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># For every frequency asked, add a alpha with the name: effective_field_ + frequency.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;REF&#39;</span>
            <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="c1"># setattr(singlemolecule, name_attr, np.array([[1, 0, 0], [0, 1, 0], [0, 0, 1]]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span>  <span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">:</span>
                <span class="n">name_attr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SM_attribute_name</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
                <span class="c1"># setattr(singlemolecule, name_attr,  np.array([[1, 0, 0], [0, 1, 0], [0, 0, 1]]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="n">singlemolecule</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_attr</span><span class="p">)</span></div>


<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="Dia_effective_field.add_single_molecule_property">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.add_single_molecule_property">[docs]</a>
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">add_single_molecule_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">L_moleculetype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        TODO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>
        <span class="n">L_mean_pos_neigh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">L_polarizability</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1"># First compute the neighbourghood:</span>
        <span class="n">L_target_mean_pos</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean_position</span>
        <span class="n">max_distance_neigh</span> <span class="o">=</span> <span class="n">moleculetype</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">effective_field_distance_neigh</span>
        <span class="n">L_environment</span><span class="p">,</span> <span class="n">L_neighbourhood_cleaned</span> <span class="o">=</span> <span class="n">universe_manager</span><span class="o">.</span><span class="n">environement_builder_return_position</span><span class="p">(</span><span class="n">kkk</span><span class="p">,</span> <span class="n">L_target_mean_pos</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">max_distance_neigh</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L_environment</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1">#case where their are neighbourgs:</span>
            <span class="k">for</span> <span class="n">k_neigh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">L_environment</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># Goes over all the neighbourging molecules. </span>
                <span class="n">pos_neigh_temp</span> <span class="o">=</span> <span class="n">L_environment</span><span class="p">[</span><span class="n">k_neigh</span><span class="p">]</span> <span class="c1"># Position of the neighbourg molecule in the target molecule framework </span>
                <span class="n">num_neigh_temp</span> <span class="o">=</span> <span class="n">L_neighbourhood_cleaned</span><span class="p">[</span><span class="n">k_neigh</span><span class="p">]</span> <span class="c1"># number of the molecule wrt the global labelling. </span>
                <span class="c1"># Find the name of the neigh molecule </span>
                <span class="k">for</span> <span class="n">k_mol_rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">L_mt_key_mt</span><span class="p">)):</span> 
                    <span class="n">molecule_type_rep</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">L_mt_key_mt</span><span class="p">[</span><span class="n">k_mol_rep</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">num_neigh_temp</span> <span class="ow">in</span> <span class="n">molecule_type_rep</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">name_neigh_temp</span> <span class="o">=</span> <span class="n">molecule_type_rep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">molecule_type_neigh</span> <span class="o">=</span> <span class="n">L_moleculetype</span><span class="p">[</span><span class="n">k_mol_rep</span><span class="p">]</span>
                            
                <span class="n">neigh_molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">name_neigh_temp</span><span class="p">))</span>
                <span class="n">L_mean_pos_neigh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neigh_molecule_type_module</span><span class="o">.</span><span class="n">compute_mean_position</span><span class="p">(</span><span class="n">pos_neigh_temp</span><span class="p">))</span>
                <span class="n">neigh_alpha</span> <span class="o">=</span> <span class="n">effective_field</span><span class="o">.</span><span class="n">find_alpha_nearest_frequency</span><span class="p">(</span><span class="n">molecule_type_neigh</span><span class="p">,</span>  <span class="n">molecule_type_neigh</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">k_neigh</span><span class="o">-</span><span class="n">molecule_type_neigh</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
                <span class="n">neigh_iota</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">rotate_2nd_order_tensor</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">molecule_type_neigh</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">k_neigh</span><span class="o">-</span><span class="n">molecule_type_neigh</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;rot_mat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">neigh_alpha</span><span class="p">)</span>      
                <span class="n">L_polarizability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neigh_iota</span><span class="p">)</span>
                    
            <span class="n">L_S</span> <span class="o">=</span> <span class="n">effective_field</span><span class="o">.</span><span class="n">compute_effective_field</span><span class="p">(</span><span class="n">L_mean_pos_neigh</span><span class="p">,</span> <span class="n">L_polarizability</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_norm</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">L_S</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
            <span class="c1"># setattr(moleculetype.L_molecule[kkk-moleculetype.L_key_mol[0]], &#39;TREATED_&#39; + name_attr, True)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The value is identity, ie the default value.</span>
            <span class="c1"># setattr(moleculetype.L_molecule[kkk-moleculetype.L_key_mol[0]], &#39;TREATED_&#39; + name_attr, True)</span>
            <span class="k">pass</span></div>

        
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="Dia_effective_field.add_value_to_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.add_value_to_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_value_to_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">moleculetype</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">kkk</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Increament the diagram value with the molecule number &#39;&#39;kkk&#39; value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">bin_to_add</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">discretization_space</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;mean_position&#39;</span><span class="p">),</span> <span class="n">sdparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="n">L_value_2d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_molecule</span><span class="p">[</span><span class="n">kkk</span><span class="o">-</span><span class="n">moleculetype</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">name_attr</span><span class="p">)</span>
        <span class="n">L_value_bin_2d</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">binarize_array</span><span class="p">(</span><span class="n">L_value_2d</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_value_to_diagram</span><span class="p">((</span><span class="n">bin_to_add</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">L_value_bin_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>       
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_population</span><span class="p">()</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="Dia_effective_field.end_frame_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Diagrams.Dia_effective_field.end_frame_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_frame_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">,</span> <span class="n">sdparameter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do after adding every molecule contribution. For instance renormalization.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_frame_diagram</span><span class="p">()</span> </div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################    </span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/frog_logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/how_to_install_frog.html">1. How to Install Frog?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials/tutorial_index.html">2. Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GlobalParameter/gp_index.html">3. Global Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MoleculeType/mt_index.html">4. Molecule Type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Diagram/diagram_index.html">5. Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalAnalysis/optical_analysis_index.html">6. Optical Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Frog.html">7. Frog package</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Guillaume Le Breton.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>