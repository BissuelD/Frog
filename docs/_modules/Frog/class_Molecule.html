<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frog.class_Molecule &#8212; Frog 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/_static/css/s4defs-roles.css" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Frog.class_Molecule</h1><div class="highlight"><pre>
<span></span><span class="c1">##############################################################################</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    FROG: FROm molecular dynamics to second harmonic Generation             #</span>
<span class="c1">#    Copyright (C) 2024                                                      #</span>
<span class="c1">#    Author list                                                             #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    Guillaume Le Breton                                                     #</span>
<span class="c1">#    Oriane Bonhomme                                                         #</span>
<span class="c1">#    Emmanuel Benichou                                                       #</span>
<span class="c1">#    Claire Loison                                                           #</span>
<span class="c1">#                                                                            # </span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify    #</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by    #</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or       #</span>
<span class="c1">#    (at your option) any later version.                                     #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,         #</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of          #</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           #</span>
<span class="c1">#    GNU General Public License for more details.                            #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">#    You should have received a copy of the GNU General Public License       # </span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/    #</span>
<span class="c1">#                                                                            #</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>   
<span class="kn">import</span> <span class="nn">copy</span> 

<span class="kn">import</span> <span class="nn">MDAnalysis</span> 

<span class="kn">import</span> <span class="nn">Frog.toolbox</span> <span class="k">as</span> <span class="nn">toolbox</span>
<span class="kn">import</span> <span class="nn">Frog.check</span> <span class="k">as</span> <span class="nn">check</span>
<span class="kn">import</span> <span class="nn">Frog.messages</span> <span class="k">as</span> <span class="nn">messages</span>
<span class="kn">import</span> <span class="nn">Frog.error_messages</span> <span class="k">as</span> <span class="nn">error_messages</span>
<span class="kn">from</span> <span class="nn">Frog.error_messages</span> <span class="kn">import</span> <span class="n">NotAnOptionError</span>

<span class="kn">import</span> <span class="nn">Frog.universe_manager</span> <span class="k">as</span> <span class="nn">universe_manager</span>
<span class="kn">import</span> <span class="nn">Frog.geometry_manager</span> <span class="k">as</span> <span class="nn">geometry_manager</span>
<span class="kn">import</span> <span class="nn">Frog.class_modules</span> <span class="k">as</span> <span class="nn">class_modules</span>
<span class="kn">import</span> <span class="nn">Frog.dalton_manager_module</span> <span class="k">as</span> <span class="nn">dalton_manager_module</span>
<span class="kn">import</span> <span class="nn">Frog.class_Diagrams</span> <span class="k">as</span> <span class="nn">class_Diagrams</span>

<span class="kn">from</span> <span class="nn">Frog.class_DiagramParameter</span> <span class="kn">import</span> <span class="n">DiagramParameter</span>
<span class="kn">from</span> <span class="nn">Frog.class_Diagrams</span> <span class="kn">import</span> <span class="n">Diagram</span>
<span class="kn">from</span> <span class="nn">Frog.class_OpticalParameter</span> <span class="kn">import</span> <span class="n">OpticalParameter</span>
<span class="kn">from</span> <span class="nn">Frog.class_OpticalParameter</span> <span class="kn">import</span> <span class="n">QMDescription</span>
<span class="kn">from</span> <span class="nn">Frog.class_OpticalParameter</span> <span class="kn">import</span> <span class="n">ElectrostaticDescription</span>
<span class="kn">from</span> <span class="nn">Frog.class_modules</span> <span class="kn">import</span> <span class="n">SingleMoleculeParameter</span>
        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
          
<div class="viewcode-block" id="MoleculeTypeParameter">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeTypeParameter">[docs]</a>
<span class="k">class</span> <span class="nc">MoleculeTypeParameter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The class containing all the parameter of the MT. This object is made just to contains other objects.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dparameter&#39;</span><span class="p">,</span> <span class="s1">&#39;optparameter&#39;</span><span class="p">,</span> <span class="s1">&#39;smparameter&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smparameter</span> <span class="o">=</span> <span class="n">SingleMoleculeParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dparameter</span> <span class="o">=</span> <span class="n">DiagramParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optparameter</span> <span class="o">=</span> <span class="n">OpticalParameter</span><span class="p">()</span>    
        
        
        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prevent the attribution of undefine object to the class. This help avoiding bad spelling mistakes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NotAnOptionError</span><span class="p">(</span><span class="s1">&#39;The name </span><span class="si">%r</span><span class="s1"> is not a valide attribute for the Diagram.&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NotAnOptionError</span><span class="p">(</span><span class="s1">&#39;The name </span><span class="si">%r</span><span class="s1"> is not a valide attribute for the Diagram.&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
<span class="c1">#################################################################################################################################           </span>
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [SingleMoleculeParameter]  </span>
<span class="sd">        </span>
<span class="sd">        Contains the SingleMoleculeParameter of this MT. See The SingleMoleculeParameter object for more information. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_smparameter</span><span class="p">)</span>
    
    <span class="nd">@smparameter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SingleMoleculeParameter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.mtparameter.smparameter can only be SingleMoleculeParameter.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the MT.mtparameter.smparameter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smparameter</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [DiagramParameter]  </span>
<span class="sd">        </span>
<span class="sd">        Contains the DiagramParameter of this MT. See The DiagramParameter object for more information. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dparameter</span><span class="p">)</span>
    
    <span class="nd">@dparameter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DiagramParameter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute  MT.mtparameter.dparameter can only be DiagramParameter.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the MT.mtparameter.dparameter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dparameter</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">#################################################################################################################################     </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [OpticalParameter]  </span>
<span class="sd">        </span>
<span class="sd">        Contains the OpticalParameter of this MT. See The OpticalParameter object for more information. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optparameter</span><span class="p">)</span>
    
    <span class="nd">@optparameter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">optparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">OpticalParameter</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.mtparameter.optparameter can only be OpticalParameter.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the MT.mtparameter.optparameter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optparameter</span> <span class="o">=</span> <span class="n">value</span>    </div>

<span class="c1">################################################################################################################################# </span>
<span class="c1">################################################################################################################################# </span>

<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="MoleculeType">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType">[docs]</a>
<span class="k">class</span> <span class="nc">MoleculeType</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">molecule_type_name</span><span class="p">,</span> <span class="n">where_are_molecules</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The most important object of the FROG software. It contains for a type of molecule (for instance &#39;WaterTIP4P&#39;) all the analysis done by the software for a given time step. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Start initializing the Molecule Type: &#39;</span> <span class="o">+</span> <span class="n">molecule_type_name</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;where_are_molecules&#39;</span><span class="p">,</span> <span class="s1">&#39;L_key_mol&#39;</span><span class="p">,</span> <span class="s1">&#39;L_key_selection_traj&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;L_molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;mtparameter&#39;</span><span class="p">,</span> <span class="s1">&#39;input_section_checks&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">molecule_type_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where_are_molecules</span> <span class="o">=</span> <span class="n">where_are_molecules</span> <span class="c1"># not usefull but to keep track of what have been used. </span>
        <span class="k">if</span> <span class="n">where_are_molecules</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">total_number_molecule</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">where_are_molecules</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_are_molecules</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">where_are_molecules</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">where_are_molecules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotAnOptionError</span><span class="p">(</span><span class="s1">&#39;WARNING: The where_are_molecules parameters can only be &quot;all&quot; or a list with exactly 2 integer.&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_key_selection_traj</span> <span class="o">=</span> <span class="n">universe_manager</span><span class="o">.</span><span class="n">trajectory_selection_for_residues</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span> <span class="o">=</span> <span class="n">MoleculeTypeParameter</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_8</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">check_molecule_basics</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_section_checks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="c1"># for read_diagram_input, read_optic_properties_input and end_initialize</span>
        
<span class="c1">#################################################################################################################################           </span>
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [string]  </span>
<span class="sd">        </span>
<span class="sd">        Name of the molecule type given when creating the instance (molecule_type_name argument). It is very important that this name refer to a molecule module defined in the frog library - for exemple, WaterTIP4P with the module WaterTIP4P.py. The name can be completly different from the one used during the MD simulation. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Defined directly by the user when creating a new Molecule Type object. The name is the second input parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    
    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute Diagram.name values can only be string.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting the MT name to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
<span class="c1">#################################################################################################################################    </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">where_are_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [string or list]  </span>
<span class="sd">        </span>
<span class="sd">        Defined what molecule of the MD are considerated as a molecule of this type. 2 way of defining this is defined:</span>
<span class="sd">        </span>
<span class="sd">        + &#39;all&#39;: to assign all the molecule available in the MD to this Molecule Type. </span>
<span class="sd">            </span>
<span class="sd">        + A list of the first and the last molecule number.  It is very important to note that only concecutivelly labelled molecule can be assign to be part of the same molecule type. </span>
<span class="sd">            Example: [1, 1700] to assign from the 1st molecule to the 1700th molecule, including the 1700th molecule. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Defined directly by the user when creating a new Molecule Type object. where_are_molecules is the third input parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_where_are_molecules</span><span class="p">)</span>
    
    <span class="nd">@where_are_molecules</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">where_are_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.where_are_molecules values can only be string, list or numpy array.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting MT </span><span class="si">%s</span><span class="s1"> where_are_molecules to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_are_molecules</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">L_key_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [list of integer]  </span>
<span class="sd">        </span>
<span class="sd">        A list where every integer is the tag of a molecule of this Molecule Type. For instance, L_key_mol = [1, 2, 3] means that in the topology file, the molecule number 1, 2 and 3 are of this molecule type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L_key_mol</span><span class="p">)</span>
    
    <span class="nd">@L_key_mol</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">L_key_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.L_key_mol values can only be list (of integer).&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting MT </span><span class="si">%s</span><span class="s1"> L_key_mol to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L_key_mol</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">L_key_selection_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [integer, integer]</span>
<span class="sd">        </span>
<span class="sd">        The first and the last atom (labelling from the topology file) of the molecule type ensemble.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L_key_selection_traj</span><span class="p">)</span>
    
    <span class="nd">@L_key_selection_traj</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">L_key_selection_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.L_key_selection_traj values can only be list (of integer).&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting MT </span><span class="si">%s</span><span class="s1"> L_key_selection_traj to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L_key_selection_traj</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [integer]</span>
<span class="sd">        </span>
<span class="sd">        Number of molecule of this type. </span>
<span class="sd">        </span>
<span class="sd">        Warning</span>
<span class="sd">        -------</span>
<span class="sd">        The number of molecule and the topology shall not change during the MD. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_population</span><span class="p">)</span>
    
    <span class="nd">@population</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.population values can only be an integer.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting MT </span><span class="si">%s</span><span class="s1"> population to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_population</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">L_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [list of SingleMolecule]</span>
<span class="sd">        </span>
<span class="sd">        A list of every molecule of this MT for a given time step. These object contains all the molecular properties computed by the software. For instance the molecule&#39;s position, orientation, beta... See the SingleMolecule object. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If you want to perform by yourself extra post-analysis, you may want to use this list. You can acces every molecule using myMT.L_molecule[molecule_number].whatever_individual_property. For instance,  myMT.L_molecule[100].electric_field_PE to acces the electric field felt by the 101th molecule of this MT at this time step. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_L_molecule</span><span class="p">)</span>
    
    <span class="nd">@L_molecule</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">L_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.L_molecule values can only be a list.&#39;</span><span class="p">)</span>
        <span class="c1"># logging.info(&#39;Setting MT %s population to %s&#39;, self.name, value) not very usefull to print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L_molecule</span> <span class="o">=</span> <span class="n">value</span>    
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mtparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [MoleculeTypeParameter]</span>
<span class="sd">        </span>
<span class="sd">        The object containing the properties of this molecule type: what analysis should be perform with this molecule type as well as usefull information regarding the expected caracteristics of this molecule type. See the other object involves like SingleMoleculeParameter, DiagramParameter or OpticalParameter. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mtparameter</span><span class="p">)</span>
    
    <span class="nd">@mtparameter</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mtparameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">MoleculeTypeParameter</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.mtparameter values can only be a list.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the MT </span><span class="si">%s</span><span class="s1"> mtparameter object.&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="c1"># can t print the mtparameter value easely print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mtparameter</span> <span class="o">=</span> <span class="n">value</span>   
<span class="c1">################################################################################################################################# </span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_section_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Type** [list of bools]</span>
<span class="sd">        </span>
<span class="sd">        Safety-intended input. This list contains booleans set to False. The number of booleans corresponds to the number of function to be called in the input section. Currenty:</span>
<span class="sd">        </span>
<span class="sd">             1) read_diagram_input</span>
<span class="sd">             2) read_optic_properties_input</span>
<span class="sd">             3) end_initialize </span>
<span class="sd">             </span>
<span class="sd">        If these function are called, they set there boolean to True</span>
<span class="sd">        After reading the input, Frog checks that the input_section_checks of every MT contains only True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_section_checks</span><span class="p">)</span>
    
    <span class="nd">@input_section_checks</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">input_section_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set value and avoid bad type or impossible values.  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The attribute MT.input_section_checks values can only be a list.&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing the MT </span><span class="si">%s</span><span class="s1"> input_section_checks object.&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_section_checks</span> <span class="o">=</span> <span class="n">value</span>
<span class="c1">################################################################################################################################# </span>
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="MoleculeType.input_section_check_update">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.input_section_check_update">[docs]</a>
    <span class="k">def</span> <span class="nf">input_section_check_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">for_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check that the previous input function has been called and update the safety-argument for this one.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_name_function</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;read_diagram_input&#39;</span><span class="p">,</span> <span class="s1">&#39;read_optic_properties_input&#39;</span><span class="p">,</span> <span class="s1">&#39;end_initialize&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">for_check</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">L_name_function</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_section_checks</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The function &#39;</span> <span class="o">+</span> <span class="n">L_name_function</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; should be called for the MT &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;. Please modify your input file accordingly.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">if</span> <span class="n">input_number</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;CODE ERROR! this case shoud not happen...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_section_checks</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The function &#39;</span> <span class="o">+</span> <span class="n">L_name_function</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; should be called before &#39;</span> <span class="o">+</span> <span class="n">L_name_function</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; in the input section for the MT &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;. Please modify your input file accordingly.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_section_checks</span><span class="p">[</span><span class="n">input_number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

        
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="MoleculeType.end_initialize">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.end_initialize">[docs]</a>
    <span class="k">def</span> <span class="nf">end_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if the analysis required can be run. Change the name of the &#39;&#39;optical&#39;&#39; diagram in case they are extracted from a response calculation at a given frequency. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_section_check_update</span><span class="p">(</span><span class="n">input_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># third input function </span>
        
        <span class="c1"># Electric field part 1/2: Update the maximal PE order asked to the optparameter:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_electric_field</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;electric_field&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;on_fly&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">pe_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">pe_level</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;PE&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">compute_electric_field_PE</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="c1"># Check if the diagrams declared and the optical part are compatible. </span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># no alpha given nor calculated</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_alpha</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_iota</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_127_a</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_alpha</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_iota</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_128_a</span><span class="p">())</span>
        
        
        <span class="c1"># Check if the diagrams declared and the optical part are compatible. </span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># no beta given nor calculated</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_beta</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_chi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_127_b</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_beta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_chi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_128_b</span><span class="p">())</span>
        
        <span class="c1"># If QM value are computed, built diagrams for every frequency asked.</span>
        <span class="c1"># alpha/iota part:  </span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end_trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">trotter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">nbr_analysis</span><span class="p">()</span> <span class="o">-</span> <span class="n">end_trotter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;iota&#39;</span><span class="p">:</span>
                    <span class="n">sdparameter_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trotter</span><span class="p">)</span> <span class="c1"># remove the diagram from the list of diagram parameter</span>
                    <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">polarizability_response</span><span class="p">:</span> 
                        <span class="n">sdparameter_toadd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="p">)</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># uptade the name of the diagram with the frequency </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdparameter_toadd</span><span class="p">)</span> <span class="c1"># add the diagram at the end of the list</span>
                        <span class="n">end_trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1">#trotter += 1 important, do not unquote this because we have removed an item previously so the trotter is the same since the list have changed! The new elements have been put at the end. </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trotter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># beta/chi part:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="n">trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end_trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">trotter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">nbr_analysis</span><span class="p">()</span> <span class="o">-</span> <span class="n">end_trotter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;beta&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span>
                    <span class="n">sdparameter_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trotter</span><span class="p">)</span> <span class="c1"># remove the diagram from the list of diagram parameter</span>
                    <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">shg_response</span><span class="p">:</span> 
                        <span class="n">sdparameter_toadd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="p">)</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">=</span> <span class="s1">&#39;dipole-dipole&#39;</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># uptade the name of the diagram with the frequency </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdparameter_toadd</span><span class="p">)</span> <span class="c1"># add the diagram at the end of the list</span>
                        <span class="n">end_trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_order</span> <span class="o">==</span> <span class="s1">&#39;quadrupole&#39;</span><span class="p">:</span>
                        <span class="n">L_beta_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dipole-quadrupole&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrupole-dipole&#39;</span><span class="p">]</span>
                        <span class="n">L_beta_type_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dq&#39;</span><span class="p">,</span> <span class="s1">&#39;qd&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">beta_type_trotter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">L_beta_type</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">shg_response</span><span class="p">:</span> 
                                <span class="n">sdparameter_toadd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="p">)</span>
                                <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
                                <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">beta_type</span> <span class="o">=</span> <span class="n">L_beta_type</span><span class="p">[</span><span class="n">beta_type_trotter</span><span class="p">]</span>
                                <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">L_beta_type_name</span><span class="p">[</span><span class="n">beta_type_trotter</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># uptade the name of the diagram with the frequency </span>
                                <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># update the size of the tensor: 3x3x3x3 instead of 3x3x3</span>
                                <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">change_bin_size_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">81</span><span class="p">)</span> <span class="c1">#update the size of the tensor for the diagram: 81 component instead of 27. </span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdparameter_toadd</span><span class="p">)</span> <span class="c1"># add the diagram at the end of the list</span>
                                <span class="n">end_trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">trotter</span> <span class="o">+=</span> <span class="mi">1</span>      
                    
        <span class="c1"># Electric field calculation part 2/2:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">compute_electric_field_PE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">IS_run_QM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: you have asked to used the environment built during the QM calculation to compute the electric field while no QM caluculation are set for this molecule type. Please initialize a QM calculation or remove the electric field diagram using the keyword &quot;PE&quot;. Note that you can compute the electric field without performing QM calculation using the keyword &quot;on_fly&quot;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">compute_electric_field_PE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">pe_level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: you have asked to compute the electrostatic field generated by the neighborhood for this MT using the QM procedure. However, for this QM calculation the PE level is -1, meaning a vacuum-like calculation. Hence, no neighborhood will be created around molecule of this MT: the electric field calculation using the &quot;PE&quot; mode is impossible! Please use &quot;on_fly&quot; instead (or pe_level=0).&#39;</span><span class="p">)</span>
        <span class="c1">#  If the QM environment is used: put the diagram after the QM calculation part in order to have the electric field calculated when it would be called.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">compute_electric_field_PE</span><span class="p">:</span>
            <span class="n">trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end_trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">trotter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">nbr_analysis</span><span class="p">()</span> <span class="o">-</span> <span class="n">end_trotter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;electric_field&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">calculation_type</span> <span class="o">==</span> <span class="s1">&#39;PE&#39;</span><span class="p">:</span>
                    <span class="n">sdparameter_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trotter</span><span class="p">)</span> <span class="c1"># remove the diagram from the list of diagram parameter</span>
                    <span class="c1"># depending on the environment builder used, the electrostatic field computed is different: </span>
                    <span class="n">change_size</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">calculation_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PE + QM box&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">long_range_switch</span><span class="p">:</span>
                            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span> <span class="c1"># the size is the good one</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">calculation_style</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PE long&#39;</span><span class="p">]:</span>
                        <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="n">change_size</span><span class="p">:</span>
                        <span class="c1"># one dimension have to be added. We go from Nx2x12xM to Nx2x2x12xM</span>
                        <span class="n">old_bin_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">bin_size</span><span class="p">)</span>
                        <span class="n">old_mean_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">mean_size</span><span class="p">)</span>
                        <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">add_bin_dimension</span><span class="p">(</span><span class="n">old_bin_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># here it is Nx2x12xMxM</span>
                        <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">change_tuple_component</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">bin_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># here it is Nx2x2xMxM</span>
                        <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">bin_size</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">change_tuple_component</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">bin_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="c1"># here it is Nx2x2x12xM</span>
                        <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">add_mean_dimension</span><span class="p">(</span><span class="n">old_mean_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># here it is Nx2x12x12</span>
                        
                        <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">mean_size</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">change_tuple_component</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">mean_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="c1"># here it is Nx2x2x12</span>
                        <span class="c1">#print(&#39;electric field mean size: &#39;, sdparameter_temp.mean_size)</span>
                        <span class="c1">#print(&#39;electric field bin size: &#39;, sdparameter_temp.bin_size)</span>
                       
                    <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="p">)</span> <span class="c1"># add the diagram at the end of the list </span>
                    <span class="n">end_trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                    
        <span class="c1"># Effective field:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_effective_field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARINING: You asked to perform effective field calculation at several frequency but you have not initialized any effective field diagram. Please add at least one effective field diagram for this molecule type.&#39;</span><span class="p">)</span>
            <span class="n">trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end_trotter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">trotter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">nbr_analysis</span><span class="p">()</span> <span class="o">-</span> <span class="n">end_trotter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s1">&#39;effective_field&#39;</span><span class="p">:</span>
                    <span class="n">sdparameter_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trotter</span><span class="p">)</span> <span class="c1"># remove the diagram from the list of diagram parameter</span>
                    <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="o">.</span><span class="n">frequency</span><span class="p">:</span> 
                        <span class="n">sdparameter_toadd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sdparameter_temp</span><span class="p">)</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
                        <span class="n">sdparameter_toadd</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sdparameter_temp</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">frequency</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># uptade the name of the diagram with the frequency </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdparameter_toadd</span><span class="p">)</span> <span class="c1"># add the diagram at the end of the list</span>
                        <span class="n">end_trotter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1">#trotter += 1 important, do not unquote this because we have removed an item previously so the trotter is the same since the list have changed! The new elements have been put at the end. </span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">trotter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">effective_field_on_beta</span><span class="p">:</span> <span class="c1"># no alpha given nor calculated</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_beta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_chi</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARINING: You asked to perform the effective field correction on the hyperpolarizability of this molecule type while you have not initialized any hyperpolarizability. Please add at least one beta or chi diagram for this molecule type.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_effective_field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARINING: You asked to perform the effective field correction on the hyperpolarizability of this molecule type while you have not initialized any effective field diagram. Please add at least one effective field diagram for this molecule type.&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_effective_field</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: you want to perform effective field diagram while you have not define the parameters. Please initialize the value: efparameter.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">GP</span><span class="o">.</span><span class="n">IS_effective_field</span> <span class="o">=</span> <span class="kc">True</span>
                
        <span class="c1"># Cases where the rotational matrix has to be initialize:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_electric_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_alpha</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_iota</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">alpha_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>            
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_beta</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_chi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">beta_calculation_style</span> <span class="o">==</span> <span class="s1">&#39;Fixed for all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
       
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_effective_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="o">.</span><span class="n">static_electric_field_direction</span> <span class="o">==</span> <span class="s1">&#39;Molecular&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span> <span class="o">=</span> <span class="kc">True</span>
         
        <span class="c1"># Better to define it at the attribute definition: in case some part of the code unset it it will be easier to debug. </span>
        <span class="c1">#if self.mtparameter.dparameter.IS_rot_mat:</span>
        <span class="c1">#    logging.info(&#39;For the MT %s,  setting the DiagramParameter.IS_rot_mat  to True.&#39;, self.name) </span>
        
        <span class="c1"># update the maximal PE level asked for this molecule type:</span>
        <span class="n">GP</span><span class="o">.</span><span class="n">PE_max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">PE_max_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">pe_level</span><span class="p">)</span>
            
        <span class="n">messages</span><span class="o">.</span><span class="n">message_with_hashtag</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;End initializing the Molecule Type: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

        <span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.initialize_empty_for_frame">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.initialize_empty_for_frame">[docs]</a>
    <span class="k">def</span> <span class="nf">initialize_empty_for_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Provide the final MoleculeType (MT) object ready for a frame analysis. Initialize the diagrams and the singlemolecule object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_empty_diagram</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_empty_molecule</span><span class="p">(</span><span class="n">GP</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.add_empty_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.add_empty_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">add_empty_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add for every analysis to do a diagram with the proper name in the MoleculeType (MT) object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">check</span><span class="o">.</span><span class="n">check_name_diagram_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trotter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">nbr_analysis</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For the molecule type: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;, initializing the diagram: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Diagram</span><span class="o">.</span><span class="n">add_empty_diagram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">[</span><span class="n">trotter</span><span class="p">]))</span></div>

            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.add_empty_molecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.add_empty_molecule">[docs]</a>
    <span class="k">def</span> <span class="nf">add_empty_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add a list of empty molecule in the MoleculeType (MT) object. Each molecule have the attribute needed to store the required analysis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">L_molecule</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">single_mololecule_empty</span> <span class="o">=</span> <span class="n">SingleMolecule</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">:</span>
            <span class="n">L_molecule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">single_mololecule_empty</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_molecule</span> <span class="o">=</span> <span class="n">L_molecule</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.merge_frame">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.merge_frame">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">otherself</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        TODO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span> <span class="c1"># for every diagram</span>
            <span class="c1"># Diagram.merge_frame(getattr(self, L_diagram_temp[0]), getattr(otherself, L_diagram_temp[0])) # merge the value of otherself in the one of self. The name of the diagram should be the same. </span>
            <span class="c1"># print(&#39;type diagram: &#39;, type(getattr(self, L_diagram_temp[0])))</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">merge_diagram</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">otherself</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="c1"># merge the value of otherself in the one of self. The name of the diagram should be the same.</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.end_diagram">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.end_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">end_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Conclude the FROG run for the diagram. Today we call just one function but if one wants to perform more analysis once all of the diagram are done here would be a nice localisation (for instance correlation analysis). </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Final preparation for the molecule type: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sdparameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_diagram</span><span class="p">:</span> <span class="c1"># for every diagram</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Final preparation for the diagram: &#39;</span> <span class="o">+</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdparameter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">end_diagram</span><span class="p">(</span><span class="n">sdparameter</span><span class="p">,</span> <span class="n">GP</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################</span>
    
<div class="viewcode-block" id="MoleculeType.check_pe_environement">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.check_pe_environement">[docs]</a>
    <span class="k">def</span> <span class="nf">check_pe_environement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        TODO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Checking that the molecule type &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; has the electrostatic behaviours description up to the order &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">PE_max_level</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; in its description file (library): &#39;</span> <span class="o">+</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="vm">__file__</span> <span class="p">)</span>
        
        <span class="n">electro_neigh</span> <span class="o">=</span> <span class="n">ElectrostaticDescription</span><span class="p">()</span>
        <span class="n">electro_neigh</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">electrostatic_description</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">PE_max_level</span><span class="p">,</span> <span class="n">electro_neigh</span><span class="p">)</span>
        <span class="c1"># electro_neigh.merge_mol(molecule_type_module.test_electrostatic(dalton_manager_module.ElectrostaticDescription()))</span>
        
        <span class="n">file_test</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">concatenate_path</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span> <span class="p">,</span> <span class="s1">&#39;exemple_electrostatic_neigh_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">generate_inp_pot</span><span class="p">(</span><span class="n">electro_neigh</span><span class="p">,</span> <span class="n">file_test</span><span class="p">,</span> <span class="n">xyz_environemnt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The molecule type &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; has an multipole description up to order: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">electro_neigh</span><span class="o">.</span><span class="n">multipole_order</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and a polarizability description up to order &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">electro_neigh</span><span class="o">.</span><span class="n">polarization_order</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. An exemple of the potential file have been created:&#39;</span> <span class="o">+</span> <span class="n">file_test</span> <span class="o">+</span> <span class="s1">&#39;.pot and a .xyz file with the site at: &#39;</span> <span class="o">+</span> <span class="n">file_test</span> <span class="o">+</span> <span class="s1">&#39;.xyz .</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################        </span>
    
<div class="viewcode-block" id="MoleculeType.check_qm_target">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.check_qm_target">[docs]</a>
    <span class="k">def</span> <span class="nf">check_qm_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        TODO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Checking that the molecule type &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; has the proper molecular information for the QM run in its description file (library): &#39;</span> <span class="o">+</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="vm">__file__</span>  <span class="o">+</span> <span class="s1">&#39; and cheking also the qmparameter in general.&#39;</span><span class="p">)</span>

        <span class="n">qmdescription</span> <span class="o">=</span> <span class="n">QMDescription</span><span class="p">()</span>
        <span class="n">qmdescription</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">qm_target_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="p">,</span> <span class="n">qmdescription</span><span class="p">)</span>
        
        <span class="n">file_test</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">concatenate_path</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">dir_torun_QM</span> <span class="p">,</span> <span class="s1">&#39;exemple_dalton_input_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">generate_inp_dal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="p">,</span> <span class="n">file_test</span> <span class="o">+</span> <span class="s1">&#39;.dal&#39;</span><span class="p">)</span> 
        <span class="n">dalton_manager_module</span><span class="o">.</span><span class="n">generate_inp_mol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">qmparameter</span><span class="p">,</span> <span class="n">file_test</span> <span class="o">+</span> <span class="s1">&#39;.mol&#39;</span><span class="p">,</span> <span class="n">qmdescription</span><span class="p">,</span> <span class="n">message_1</span><span class="o">=</span><span class="s1">&#39;This is a test using the typical_geometry function of the molecule library module.&#39;</span><span class="p">,</span> <span class="n">message_2</span><span class="o">=</span><span class="s1">&#39;Note that the QM run will be performed in the laboratory frame later on&#39;</span><span class="p">)</span> 
      
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The molecule type &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; QM parameter seems to work. Typical file for the Dalton run have been written at: &#39;</span><span class="o">+</span> <span class="n">file_test</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

                        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.check_molecule_basics">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.check_molecule_basics">[docs]</a>
    <span class="k">def</span> <span class="nf">check_molecule_basics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if the molecule provided in the input file are found in the MD trajectory with the good geometry.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Load the positions of the residues which should be the one defined in the type for the first frame</span>
        
        <span class="c1"># u, ts, L_box_size = universe_manager.trajectory_load_old(GP, 0, try_cut_traj=False) </span>
        <span class="c1"># CL modification</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="n">universe_manager</span><span class="o">.</span><span class="n">trajectory_load</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">try_cut_traj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
        <span class="n">L_box_size</span> <span class="o">=</span> <span class="n">pbc</span><span class="o">.</span><span class="n">L_box_size</span>

        <span class="c1"># L_traj = np.array(ts.positions[self.L_key_selection_traj[0]:self.L_key_selection_traj[1]])</span>
        <span class="n">L_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s2">&quot;resid &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        
        <span class="c1"># Load the module where the molecule parameter are defined -- should be in Frog/Molecules:</span>
        <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="c1"># Read the single molecule parameter (smparameter) from the module:        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">info_molecule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">)</span>
        <span class="c1"># Print the molecular geometry understood by FROG:   </span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_9</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         # Check that there is the good number of atom in the selection:     </span>
<span class="sd">        if L_traj.shape[0] != self.population*self.mtparameter.smparameter.nbr_atom:</span>
<span class="sd">            raise Exception(error_messages.e_102(self, molecule_type_module, L_traj.shape[0])  )</span>
<span class="sd">        # Check the molecule geometry for every molecule of the type:  </span>
<span class="sd">        for molecule in range(0, self.population, 1):</span>
<span class="sd">                L_pos_mol = np.array(L_traj[self.mtparameter.smparameter.nbr_atom*molecule:self.mtparameter.smparameter.nbr_atom*(molecule+1)][:])</span>
<span class="sd">                not_interested = geometry_manager.check_molecule_geometry(self.mtparameter.smparameter, L_pos_mol, GP.box_size)</span>
<span class="sd">        messages.user_frendly_10()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Check that there is the good number of atom in the selection:     </span>
        <span class="k">if</span> <span class="n">L_traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="o">.</span><span class="n">nbr_atom</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_messages</span><span class="o">.</span><span class="n">e_102</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">L_traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="p">)</span>
        <span class="c1"># Check the molecule geometry for every molecule of the type:  </span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_key_mol</span><span class="p">:</span>
            <span class="n">L_pos_mol</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s2">&quot;resid &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">residue</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
            <span class="n">not_interested</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">L_pos_mol</span><span class="p">,</span> <span class="n">GP</span><span class="o">.</span><span class="n">box_size</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">user_frendly_10</span><span class="p">()</span></div>

        
<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="MoleculeType.check_polarizable_description">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.check_polarizable_description">[docs]</a>
    <span class="k">def</span> <span class="nf">check_polarizable_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check that this molecule type has a backup description of its polarizability. It will first check on the optical parameter, then on the molecular module.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># check polarizability description</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The backup polarizability for the MT &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has been given by the user and is:</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The backup polarizability for the MT &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has not been given by the user. Therefore, the reference value will be read from the molecular module in the function: ref_polarizability.&#39;</span><span class="p">)</span>
            <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">ref_polarizability</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The value found in the molecular module is: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">L_alpha_ref</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Note that the used polarizability can depend on the frequency.&#39;</span><span class="p">)</span>
        
        <span class="c1"># check max distance to built neighbourhood </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="o">.</span><span class="n">max_distance_neigh</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">efparameter</span><span class="o">.</span><span class="n">max_distance_neigh</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">ef_max_distance_neigh</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The maximal distance to built the neighbourhood for molecules of this molecule type during the effective field procedure is set to be: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">ef_max_distance_neigh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (maximal value defined within the different molecule type)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The maximal distance to built the neighbourhood for molecules of this molecule type during the effective field procedure is set to be: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">GP</span><span class="o">.</span><span class="n">ef_max_distance_neigh</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (maximal value defined within the different molecule type)&#39;</span><span class="p">)</span></div>

        
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="MoleculeType.read_diagram_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.read_diagram_input">[docs]</a>
    <span class="k">def</span> <span class="nf">read_diagram_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">L_diagram_analysis_to_perform</span><span class="p">,</span> <span class="n">special_selection</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function was made to make the user input simplier.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_section_check_update</span><span class="p">(</span><span class="n">input_number</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># first input function </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">read_diagram_input</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">L_diagram_analysis_to_perform</span><span class="p">,</span> <span class="n">special_selection</span><span class="p">)</span> </div>


<span class="c1">#################################################################################################################################</span>
        
<div class="viewcode-block" id="MoleculeType.read_optic_properties_input">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.MoleculeType.read_optic_properties_input">[docs]</a>
    <span class="k">def</span> <span class="nf">read_optic_properties_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">alpha_calculation_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">L_alpha_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">beta_calculation_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">L_beta_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">beta_order</span><span class="o">=</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="n">effective_field_on_beta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">efparameter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">effective_field_distance_neigh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">where_to_run_QM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qmparameter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">selection_tool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Defines the Optical Parameter of this MT. </span>
<span class="sd">        </span>
<span class="sd">        One input is mandatory: the GlobalParameter (GP) of the run as first argument. </span>
<span class="sd">        </span>
<span class="sd">        The other arguments are optional in the sens that they have a default value is not given by the user. See the Optical Parameter attribute for more information about them. </span>
<span class="sd">        </span>
<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        A good habit can be to first defines the attributes value in your input file, and then to pass them to this function: ::</span>
<span class="sd">        </span>
<span class="sd">            alpha_calculation_style = &#39;Fixed for all&#39;</span>
<span class="sd">            L_alpha_ref = np.array([[9.8, 0, 0], [0, 9.8, 0], [0, 0, 9.8]])</span>
<span class="sd">            myMT.read_optic_properties_input(GP, alpha_calculation_style=alpha_calculation_style, L_alpha_ref=L_alpha_ref)</span>
<span class="sd">        </span>
<span class="sd">        Warning</span>
<span class="sd">        -------</span>
<span class="sd">        Today, the attributes effective_field_on_beta, efparameter and effective_field_distance_neigh SHALL NOT be used. They were designed for effective field calculation, which is not yet complete in Frog. </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This function was made to make the user input simplier, right? </span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        In the rest of the documentation, this function call is often written as read_optic_properties_input(..., the_argument=value, ...). In any case, you should defines always the GP first, and all the other attribute you need in only one call. If you are not using an attribute, just do not define it or set its value to the default one. </span>
<span class="sd">        &#39;&#39;&#39;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_section_check_update</span><span class="p">(</span><span class="n">input_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># second input function </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">read_optic_properties_input</span><span class="p">(</span><span class="n">GP</span><span class="p">,</span> <span class="n">alpha_calculation_style</span><span class="p">,</span> <span class="n">L_alpha_ref</span><span class="p">,</span> <span class="n">beta_calculation_style</span><span class="p">,</span> <span class="n">L_beta_ref</span><span class="p">,</span> <span class="n">beta_order</span><span class="p">,</span> <span class="n">effective_field_on_beta</span><span class="p">,</span> <span class="n">efparameter</span><span class="p">,</span> <span class="n">where_to_run_QM</span><span class="p">,</span> <span class="n">qmparameter</span><span class="p">,</span> <span class="n">selection_tool</span><span class="p">)</span></div>
</div>

        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
   
<div class="viewcode-block" id="SingleMolecule">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.SingleMolecule">[docs]</a>
<span class="k">class</span> <span class="nc">SingleMolecule</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GP</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_position&#39;</span><span class="p">]</span> <span class="c1">#more attribute can be added depending on the analysis asked.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">GP</span><span class="o">.</span><span class="n">IS_layer_selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;layer&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="c1"># initialized the value for every analysis</span>
        <span class="k">for</span> <span class="n">possible_analysis</span> <span class="ow">in</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">L_possible_diagram</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="p">,</span> <span class="s1">&#39;IS_&#39;</span> <span class="o">+</span> <span class="n">possible_analysis</span><span class="p">):</span>
                <span class="c1">#print(possible_analysis)</span>
                <span class="n">class_temp_diagram</span> <span class="o">=</span> <span class="n">class_modules</span><span class="o">.</span><span class="n">give_class_diagram_name</span><span class="p">(</span><span class="n">possible_analysis</span><span class="p">)</span> <span class="c1">#name of the class relative to the analysis requiered </span>
                <span class="n">class_Diagrams</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="n">class_temp_diagram</span><span class="p">)</span><span class="o">.</span><span class="n">initialize_single_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">)</span> <span class="c1"># TODO.</span>
        
        <span class="k">if</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">dparameter</span><span class="o">.</span><span class="n">IS_rot_mat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rot_mat&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">mtparameter</span><span class="o">.</span><span class="n">optparameter</span><span class="o">.</span><span class="n">IS_run_QM</span><span class="p">:</span>
            <span class="n">class_temp_diagram</span> <span class="o">=</span> <span class="s1">&#39;Prepare_run_QM&#39;</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">class_Diagrams</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="n">class_temp_diagram</span><span class="p">)</span><span class="o">.</span><span class="n">initialize_single_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mtparameter</span><span class="p">)</span> <span class="c1"># TODO.</span>
        
        <span class="k">for</span> <span class="n">name_attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_attribute</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
<span class="c1">#################################################################################################################################</span>

<div class="viewcode-block" id="SingleMolecule.compute_mean_position">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.SingleMolecule.compute_mean_position">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_mean_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span>  <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the mean position of the molecule using the function defined in the molecule type library file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;mean_position&#39;</span>
        <span class="c1">#pos_mol_kkk = L_traj[(L_key_selection_traj[0]+kkk*smparameter.nbr_atom):(L_key_selection_traj[0]+(kkk+1)*smparameter.nbr_atom)]</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resid &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">pos_mol_kkk</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">compute_mean_position</span><span class="p">(</span><span class="n">pos_mol_kkk</span><span class="p">))</span> </div>

        
<span class="c1">#################################################################################################################################</span>
  
<div class="viewcode-block" id="SingleMolecule.compute_rot_matrix">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.SingleMolecule.compute_rot_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_rot_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="p">,</span> <span class="n">smparameter</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute the rotational matrix</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name_attr</span> <span class="o">=</span> <span class="s1">&#39;rot_mat&#39;</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">select_atoms</span><span class="p">(</span><span class="s1">&#39;resid &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kkk</span><span class="p">))</span><span class="o">.</span><span class="n">positions</span>
        <span class="n">pos_mol_kkk</span> <span class="o">=</span> <span class="n">geometry_manager</span><span class="o">.</span><span class="n">check_molecule_geometry</span><span class="p">(</span><span class="n">smparameter</span><span class="p">,</span> <span class="n">pos_mol_kkk</span><span class="p">,</span> <span class="n">L_box_size</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_attr</span><span class="p">,</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">compute_rotational_matrix</span><span class="p">(</span><span class="n">pos_mol_kkk</span><span class="p">))</span> </div>

        
<span class="c1">################################################################################################################################</span>
  
<div class="viewcode-block" id="SingleMolecule.print_typical_position">
<a class="viewcode-back" href="../../Frog.html#Frog.class_Molecule.SingleMolecule.print_typical_position">[docs]</a>
    <span class="k">def</span> <span class="nf">print_typical_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MT_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        when the trajectory is not available</span>
<span class="sd">        print the typical position  of this molecule in XYZ format</span>
<span class="sd">        from the mean position and the rotational matrix  of this single molecule</span>
<span class="sd">        and the typical geometry of the molecule type</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">module_MT_name</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">creat_name_for_MT_module_load</span><span class="p">(</span><span class="n">MT_name</span><span class="p">)</span>
        <span class="n">molecule_type_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_MT_name</span><span class="p">)</span>
        <span class="n">smparameter</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">info_molecule</span><span class="p">(</span><span class="n">SingleMoleculeParameter</span><span class="p">())</span>
        <span class="n">position_mol_axis</span> <span class="o">=</span> <span class="n">molecule_type_module</span><span class="o">.</span><span class="n">typical_geometry</span><span class="p">()</span>
        <span class="n">rot_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot_mat</span>

        <span class="c1"># for all atoms, perform a rotation and a translation</span>
        <span class="c1"># A VERIFIER SI C&#39;EST LA BONNE ROTATION !</span>
        <span class="n">new_atom_position</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom_position</span> <span class="ow">in</span> <span class="n">position_mol_axis</span> <span class="p">:</span>
            <span class="n">new_atom_position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">atom_position</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_position</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="p">:</span>
            <span class="n">mol_name</span> <span class="o">=</span> <span class="n">smparameter</span><span class="o">.</span><span class="n">name_mt</span>
            <span class="n">atom_num</span> <span class="o">=</span> <span class="n">smparameter</span><span class="o">.</span><span class="n">nbr_atom</span>
            <span class="n">atom_types</span> <span class="o">=</span>  <span class="n">smparameter</span><span class="o">.</span><span class="n">L_type_atom</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>     
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">atom_num</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span>  <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atom_num</span><span class="p">):</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">atom_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">new_atom_position</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">new_atom_position</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">new_atom_position</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">new_atom_position</span><span class="p">)</span></div>
</div>


<span class="c1">#################################################################################################################################</span>
        
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
<span class="c1">#################################################################################################################################</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/frog_logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/how_to_install_frog.html">1. How to Install Frog?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorials/tutorial_index.html">2. Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GlobalParameter/gp_index.html">3. Global Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MoleculeType/mt_index.html">4. Molecule Type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Diagram/diagram_index.html">5. Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../OpticalAnalysis/optical_analysis_index.html">6. Optical Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Frog.html">7. Frog package</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Guillaume Le Breton.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>